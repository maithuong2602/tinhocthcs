<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Bài Tập | Công Cụ Quản Lý Đề Thi</title>
    <!-- Thêm thư viện Font Awesome để sử dụng icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- HỆ THỐNG THIẾT KẾ ĐỒNG BỘ --- */
        :root {
            --primary-color: #0056b3;
            --primary-color-light: #007bff;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --background-color: #f4f7fa;
            --card-background: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --font-family: 'Be Vietnam Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            color: var(--text-color);
            font-size: 16px;
        }

        .page-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: var(--primary-color);
        }

        .header p {
            font-size: 1.1em;
            color: var(--secondary-color);
            max-width: 700px;
            margin: 0 auto;
        }

        .main-content-wrapper {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            gap: 30px;
            align-items: flex-start;
        }

        /* --- CARD STYLE (Thay thế cho .section) --- */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 30px;
        }
        .card:last-child {
             margin-bottom: 0;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-family);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
        }
        .form-group textarea { resize: vertical; min-height: 120px; }

        /* --- QUESTION CONTAINER --- */
        .question-container {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            background: #fdfdfd; /* Nền hơi khác để nổi bật */
        }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .question-title { font-weight: 700; color: var(--text-color); font-size: 1.1em; }
        .options-container { margin-top: 15px; }
        .option-group { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .option-group input[type="text"] { flex: 1; }
        .option-group input[type="checkbox"] { flex-shrink: 0; width: 20px; height: 20px; accent-color: var(--primary-color); }
        
        /* --- UNIFIED BUTTON SYSTEM --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-family);
            transition: transform 0.2s ease, filter 0.2s ease;
            width: 100%; /* Default to full-width for groups */
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(0.95); }
        .btn.btn-sm { padding: 8px 12px; font-size: 0.9rem; }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: var(--text-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: var(--text-color); }

        .button-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;}
        .button-actions .btn { width: auto; } /* Nút trong group nhỏ thì không full-width */

        .main-actions-group {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* --- OUTPUT & SIDE PANEL --- */
        .output-container {
            margin-top: 30px;
            display: none;
        }
        #question-summary { white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; background-color: #e9ecef; padding: 15px; border-radius: 8px; min-height: 50px; }
        .copy-button { margin-top: 15px; width: auto; }

        .sticky-panel-wrapper { position: relative; }
        .sticky-panel {
            position: sticky;
            top: 30px;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .dac-ta-level { margin-bottom: 15px; }
        .dac-ta-level h4 { font-size: 1.1em; color: var(--primary-color); margin-bottom: 8px; font-weight: 600; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .dac-ta-list { list-style-position: inside; padding-left: 5px; }
        .dac-ta-list li { font-size: 14px; color: var(--text-color); margin-bottom: 8px; line-height: 1.5; }

        /* --- MODAL --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal.is-visible {
            display: flex;
        }
        .modal-content { 
            background-color: var(--card-background); 
            margin: auto; 
            padding: 30px; 
            border: none; 
            width: 90%; 
            max-width: 700px; 
            border-radius: 12px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); 
            animation: fadeIn 0.3s ease-out;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--primary-color); font-size: 1.5rem; gap: 10px; display: flex; align-items: center;}
        .close-button { color: #aaa; background: none; border: none; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-button:hover, .close-button:focus { color: var(--text-color); }
        #bulk-instructions { font-size: 14px; color: var(--secondary-color); background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        #bulk-textarea { min-height: 300px; }
        #alert-modal-message { white-space: pre-wrap; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- RESPONSIVE --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .error-highlight { border-color: var(--danger-color) !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important; }

        @media (max-width: 1200px) {
            .main-content-wrapper { grid-template-columns: 1fr; }
            .sticky-panel { position: static; max-height: none; }
        }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .main-actions-group { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <h1><i class="fa-solid fa-file-signature"></i> Tạo Bài Tập Theo Định Dạng</h1>
            <p>Hệ thống tạo file Word hoàn chỉnh với mã nhận thức và tiêu chí cụ thể.</p>
        </header>

        <main class="main-content-wrapper">
            <div class="form-container">
                <section class="card">
                    <h2 class="card-title"><i class="fa-solid fa-circle-info"></i> PHẦN 1: THÔNG TIN CHUNG</h2>
                    <div class="grid-2">
                        <div class="form-group"><label for="khoi">Khối:</label><select id="khoi"><option value="">-- Chọn khối --</option><option value="6">Khối 6</option><option value="7">Khối 7</option><option value="8">Khối 8</option><option value="9">Khối 9</option></select></div>
                        <div class="form-group"><label for="bai">Bài (sẽ là tiêu đề chính):</label><select id="bai" disabled><option value="">-- Vui lòng chọn khối trước --</option></select></div>
                    </div>
                </section>

                <section class="card">
                    <h2 class="card-title"><i class="fa-solid fa-list-check"></i> PHẦN 1. Trắc nghiệm</h2>
                    <div id="multiple-choice-questions"></div>
                    <div class="button-actions">
                        <button id="add-mc-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Thêm câu hỏi</button>
                        <button id="bulk-add-btn" class="btn btn-secondary"><i class="fa-solid fa-layer-group"></i> Thêm hàng loạt</button>
                    </div>
                </section>

                <section class="card">
                    <h2 class="card-title"><i class="fa-solid fa-pen-ruler"></i> PHẦN 2. Tự luận</h2>
                    <div id="essay-questions"></div>
                    <div class="button-actions">
                         <button id="add-essay-btn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Thêm câu hỏi</button>
                    </div>
                </section>
                
                <section class="card">
                    <h2 class="card-title"><i class="fa-solid fa-chart-simple"></i> Thống kê số câu hỏi</h2>
                    <div id="question-summary">Chưa có câu hỏi nào được định nghĩa đầy đủ.</div>
                </section>

                <div class="main-actions-group">
                    <button id="generate-doc-btn" class="btn btn-success"><i class="fa-solid fa-rocket"></i> Tạo Tài Liệu</button>
                    <button id="export-json-btn" class="btn btn-warning"><i class="fa-solid fa-file-export"></i> Xuất JSON</button>
                    <label for="json-import-input" class="btn btn-info"><i class="fa-solid fa-file-import"></i> Nhập JSON</label>
                    <input type="file" id="json-import-input" accept=".json" style="display: none;" multiple>
                </div>

                <div class="output-container card" id="output-container">
                     <h3 class="card-title"><i class="fa-solid fa-file-lines"></i> Nội dung tài liệu được tạo:</h3>
                     <div class="form-group">
                         <textarea class="form-control" id="output-content" rows="10" readonly style="font-family: 'Courier New', monospace; background: #f8f9fa;"></textarea>
                     </div>
                     <button id="copy-btn" class="btn btn-secondary copy-button"><i class="fa-solid fa-copy"></i> Sao chép nội dung</button>
                </div>
            </div>

            <aside class="sticky-panel-wrapper">
                 <div class="sticky-panel card">
                     <h3 class="card-title"><i class="fa-solid fa-book-open"></i> Yêu Cầu Cần Đạt</h3>
                     <div id="dac-ta-panel-content">
                         <p>Vui lòng chọn khối và bài để xem yêu cầu cần đạt.</p>
                     </div>
                 </div>
            </aside>
        </main>
    </div>

    <!-- Modal thêm hàng loạt -->
    <div id="bulk-add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-layer-group"></i> Thêm hàng loạt câu hỏi trắc nghiệm</h2>
                <button class="close-button" id="close-bulk-modal-btn">&times;</button>
            </div>
            <p><strong>Các tiêu chí tham khảo (dựa trên lựa chọn của bạn):</strong></p>
            <div id="bulk-criteria-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; background: #f8f9fa; margin-bottom: 15px; font-size: 14px;">
                    <!-- Dynamic content will be inserted here by JavaScript -->
            </div>
            <div id="bulk-instructions">
                 <p>Tạo 20 câu hỏi trắc nghiệm hoặc điền khuyết dựa trên các tiêu chí mà tôi cung cấp.</p>
                <p><strong>Yêu cầu:</strong></p>
                <ul>
                    <li>Mã câu theo cú pháp <code>[mức].[mã tiêu chí].[STT]</code>
                        <ul>
                            <li>mức: 1 = NB, 2 = TH, 3 = VD, 4 = VDC</li>
                            <li>mã tiêu chí: đúng theo tiêu chí tôi cung cấp</li>
                            <li>STT: số thứ tự câu trong tiêu chí, bắt đầu từ 1</li>
                        </ul>
                    </li>
                    <li>Chỉ tạo câu cho mức độ thực sự tồn tại trong tiêu chí. Nếu một nhóm mức độ không có tiêu chí, có thể lấy câu bổ sung từ các nhóm khác để đủ 20 câu.</li>
                    <li>Nếu có nhiều đáp án đúng → dùng chữ cái a, b, c, d (với dấu * trước mỗi đáp án đúng). Nếu chỉ có 1 đáp án đúng → dùng chữ cái A, B, C, D.</li>
                    <li>Thêm dấu <code>*</code> trước đáp án đúng.</li>
                    <li>Cuối cùng thêm <code>ANSWER KEYS</code> cho các câu điền khuyết. Các câu điền khuyết phải để ở cuối sau tất cả câu trắc nghiệm.</li>
                    <li>Chỉ hiển thị câu hỏi và đáp án, không giải thích, không thêm nội dung nào khác, không có các câu dẫn dắt.</li>
                </ul>
                 <p><strong>Định dạng mẫu:</strong></p>
                 <p><em>Câu có đáp án đúng duy nhất:</em></p>
<pre>Câu [mức].[mã tiêu chí].[STT] ([Mức]): [Nội dung câu hỏi]
*A. [Đáp án đúng]
B. [Đáp án sai 1]
C. [Đáp án sai 2]
D. [Đáp án sai 3]</pre>
                 <p><em>Câu có nhiều đáp án đúng:</em></p>
<pre>Câu [mức].[mã tiêu chí].[STT] ([Mức]): [Nội dung câu hỏi]
*a. [Đáp án đúng 1]
*b. [Đáp án đúng 2]
c. [Đáp án sai 1]
d. [Đáp án sai 2]</pre>
                <p><em>Câu điền khuyết:</em></p>
<pre>Câu [mức].[mã tiêu chí].[STT] ([Mức]): Hoàn thành câu sau: [Câu hỏi]

ANSWER KEYS
[mức].[mã tiêu chí].[STT]. [Đáp án điền khuyết]</pre>
                <p><strong>TIÊU CHÍ (người dùng sẽ nhập vào sau):</strong></p>
                <p>Ví dụ:<br><em>1.1 Trình bày được sơ lược lịch sử phát triển máy tính.</em><br><em>2.1 Nêu được ví dụ cho thấy sự phát triển máy tính đem lại thay đổi lớn cho xã hội.</em></p>
            </div>
            <button id="copy-instructions-btn" class="btn btn-primary" style="margin-bottom: 15px; width: auto;"><i class="fa-solid fa-copy"></i> Sao chép Hướng dẫn & Tiêu chí</button>
            <div class="form-group">
                <textarea id="bulk-textarea" placeholder="Dán danh sách câu hỏi của bạn vào đây..."></textarea>
            </div>
            <button id="process-bulk-btn" class="btn btn-primary" style="margin-top: 10px;">
                <i class="fa-solid fa-check"></i> Thêm / Cập nhật câu hỏi
            </button>
        </div>
    </div>

    <!-- Modal thông báo tùy chỉnh -->
    <div id="alert-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-header" style="justify-content: center; border-bottom: none;">
                <h2 id="alert-modal-title">Thông báo</h2>
            </div>
            <p id="alert-modal-message" style="margin-bottom: 20px; font-size: 1.1rem;"></p>
            <button id="close-alert-btn" class="btn btn-primary" style="width: auto; min-width: 100px;">OK</button>
        </div>
    </div>

    <script>
    // =================================================================================
    // REFACTORED SCRIPT
    // The entire application logic is encapsulated within the 'App' object to avoid
    // polluting the global scope. Event listeners are attached programmatically in
    // the 'init' method for better separation of concerns.
    // =================================================================================
    const App = {
        // --- STATE AND DATA ---
        mcQuestionCount: 0,
        essayQuestionCount: 0,
        debounceTimer: null,
        lessonData: { '6': ["Bài 1. Thông tin và dữ liệu", "Bài 2. Xử lí thông tin", "Bài 3. Thông tin trong máy tính", "Bài 4. Mạng máy tính", "Bài 5. Internet", "Bài 6. Mạng thông tin toàn cầu", "Bài 7. Tìm kiếm thông tin trên Internet", "Bài 8. Thư điện tử", "Bài 9. An toàn thông tin trên Internet", "Bài 10. Sơ đồ tư duy", "Bài 11. Định dạng văn bản", "Bài 12. Trình bày thông tin ở dạng bảng", "Bài 13. Thực hành: Tìm kiếm và thay thế", "Bài 14. Thực hành tổng hợp: Hoàn thiện sổ lưu niệm", "Bài 15. Thuật toán", "Bài 16. Các cấu trúc điều khiển", "Bài 17. Chương trình máy tính"], '7': ["Bài 1: Thiết bị vào - ra", "Bài 2: Phần mềm máy tính", "Bài 3: Quản lí dữ liệu trong máy tính", "Bài 4: Mạng xã hội và một số kênh trao đổi thông tin trên Internet", "Bài 5: Ứng xử trên mạng", "Bài 6: Làm quen với phần mềm bảng tính", "Bài 7: Tính toán tự động trên bảng tính", "Bài 8: Công cụ hỗ trợ tính toán", "Bài 9: Trình bày bảng tính", "Bài 10: Hoàn thiện bảng tính", "Bài 11: Tạo bài trình chiếu", "Bài 12: Định dạng đối tượng trên trang chiếu", "Bài 13: Thực hành tổng hợp: Hoàn thiện bài trình chiếu", "Bài 14: Thuật toán tìm kiếm tuần tự", "Bài 15: Thuật toán tìm kiếm nhị phân", "Bài 16: Thuật toán sắp xếp"], '8': ["Bài 1: Lược sử công cụ tính toán", "Bài 2: Thông tin trong môi trường số", "Bài 3: Thực hành: Khai thác thông tin số", "Bài 4: Đạo đức và văn hóa trong sử dụng công nghệ kĩ thuật số", "Bài 5: Sử dụng bảng tính giải quyết bài toán thực tế", "Bài 6: Sắp xếp và lọc dữ liệu", "Bài 7: Trình bày dữ liệu bằng biểu đồ", "Bài 8a: Làm việc với danh sách dạng liệt kê và hình ảnh trong văn bản", "Bài 8b: Phần mềm chỉnh sửa ảnh", "Bài 9a: Tạo đầu trang, chân trang cho văn bản", "Bài 9b: Thay đổi khung hình, kích thước ảnh", "Bài 10a: Định dạng nâng cao cho trang chiếu", "Bài 10b: Thêm văn bản, tạo hiệu ứng cho ảnh", "Bài 11a: Sử dụng văn bản mẫu tạo bài trình chiếu", "Bài 11b: Thực hành tổng hợp", "Bài 12: Từ thuật toán đến chương trình", "Bài 13: Biểu diễn dữ liệu", "Bài 14: Cấu trúc điều khiển", "Bài 15: Gỡ lỗi", "Bài 16: Tin học với nghề nghiệp"], '9': ["Bài 1. Thế giới kĩ thuật số", "Bài 2. Thông tin trong giải quyết vấn đề", "Bài 3. Thực hành: Đánh giá chất lượng thông tin", "Bài 4. Một số vấn đề pháp lí về sử dụng dịch vụ Internet", "Bài 5. Tìm hiểu phần mềm mô phỏng", "Bài 6. Thực hành: Khai thác phần mềm mô phỏng", "Bài 7. Trình bày thông tin trong trao đổi và hợp tác", "Bài 8. Thực hành: Sử dụng công cụ trực quan trình bày thông tin trong trao đổi và hợp tác", "Bài 9a. Sử dụng công cụ xác thực dữ liệu", "Bài 10a. Sử dụng hàm COUNTIF", "Bài 11a. Sử dụng hàm SUMIF", "Bài 12a. Sử dụng hàm IF", "Bài 13a. Hoàn thiện bảng tính quản lí tài chính gia đình", "Bài 9b. Các chức năng chính của phần mềm làm video", "Bài 10b. Chuẩn bị dữ liệu và dựng video", "Bài 11b. Thực hành: Dựng video theo kịch bản", "Bài 12b. Hoàn thành việc dựng video", "Bài 13b. Biên tập và xuất video", "Bài 14. Giải quyết vấn đề", "Bài 15. Bài toán tin học", "Bài 16. Thực hành: Lập chương trình máy tính", "Bài 17. Tin học và thế giới nghề nghiệp"] },
        criteriaData: { "6": { "Bài 1. Thông tin và dữ liệu": { "NB": ["1.1 Phân biệt được thông tin với vật mang tin.", "1.2 Nhận biết được sự khác nhau giữa thông tin và dữ liệu."], "TH": ["2.1 Nêu được ví dụ minh hoạ về mối quan hệ giữa thông tin và dữ liệu.", "2.2 Nêu được ví dụ minh hoạ tầm quan trọng của thông tin."] }, "Bài 2. Xử lí thông tin": { "NB": ["1.1 Nêu được các bước cơ bản trong xử lí thông tin."], "VD": ["3.1 Giải thích được máy tính và các thiết bị số là công cụ hiệu quả để thu thập, lưu trữ, xử lí và truyền thông tin. Nêu được ví dụ minh hoạ cụ thể."] }, "Bài 3. Thông tin trong máy tính": { "NB": ["1.1 Biết được bit là đơn vị nhỏ nhất trong lưu trữ thông tin.", "1.2 Nêu được tên và độ lớn của các đơn vị cơ bản đo dung lượng thông tin."], "TH": ["2.1 Giải thích được có thể biểu diễn thông tin chỉ với hai kí hiệu 0 và 1."], "VDC": ["4.1 Xác định được khả năng lưu trữ của các thiết bị nhớ thông dụng."] }, "Bài 4. Mạng máy tính": { "NB": ["1.1 Nêu được khái niệm và lợi ích của mạng máy tính.", "1.2 Nêu được các thành phần chủ yếu của một mạng máy tính (máy tính và thiết bị kết nối) và tên của một vài thiết bị mạng cơ bản như: máy tính, cáp nối, Switch, Access Point,…"], "TH": ["2.1 Nêu được ví dụ cụ thể về trường hợp mạng không dây tiện dụng hơn mạng có dây."] }, "Bài 5. Internet": { "NB": ["1.1 Nêu được các đặc điểm và ích lợi chính của Internet."] }, "Bài 6. Mạng thông tin toàn cầu": { "NB": ["1.1 Trình bày được sơ lược về các khái niệm WWW, website, địa chỉ của website, trình duyệt.", "1.2 Xem và nêu được những thông tin chính trên trang web cho trước."], "VDC": ["4.1 Tìm kiếm được thông tin trên một số trang web thông dụng như: tra từ điển, xem thời tiết, tin thời sự,... để phục vụ cho nhu cầu học tập và cuộc sống."] }, "Bài 7. Tìm kiếm thông tin trên Internet": { "NB": ["1.1 Nêu được công dụng của máy tìm kiếm."], "TH": ["2.1 Xác định được từ khoá ứng với một mục đích tìm kiếm cho trước."] }, "Bài 8. Thư điện tử": { "NB": ["1.1 Biết cách đăng kí tài khoản thư điện tử."], "TH": ["2.1 Nêu được những ưu, nhược điểm cơ bản của dịch vụ thư điện tử so với các phương thức liên lạc khác."], "VDC": ["4.1 Thực hiện được một số thao tác cơ bản: tạo tài khoản email, đăng nhập tài khoản email, soạn thư, gửi thư, nhận thư, trả lời thư, chuyển tiếp thư và đăng xuất hộp thư trong một số tình huống thực tiễn."] }, "Bài 9. An toàn thông tin trên Internet": { "NB": ["1.1 Nêu được một số tác hại và nguy cơ bị hại khi tham gia Internet.", "1.2 Nêu được một vài cách thông dụng để bảo vệ, chia sẻ thông tin của bản thân và tập thể sao cho an toàn và hợp pháp."], "TH": ["2.1 Nêu và thực hiện được một số biện pháp cơ bản để phòng ngừa tác hại khi tham gia Internet với sự hướng dẫn của giáo viên.", "2.2 Trình bày được tầm quan trọng của sự an toàn và hợp pháp của thông tin cá nhân và tập thể, nêu được ví dụ minh hoạ.", "2.3 Nhận diện được một số thông điệp (chẳng hạn email, yêu cầu kết bạn, lời mời tham gia câu lạc bộ,...) lừa đảo hoặc mang nội dung xấu."], "VD": ["3.1 Thực hiện được các thao tác để bảo vệ thông tin và tài khoản cá nhân."] }, "Bài 10. Sơ đồ tư duy": { "TH": ["2.1 Giải thích được lợi ích của sơ đồ tư duy, nêu được nhu cầu sử dụng phần mềm sơ đồ tư duy trong học tập và trao đổi thông tin."], "VD": ["3.1 Sắp xếp được một cách logic và trình bày được dưới dạng sơ đồ tư duy các ý tưởng, khái niệm."], "VDC": ["4.1 Sử dụng được phần mềm để tạo sơ đồ tư duy đơn giản phục vụ học tập và trao đổi thông tin."] }, "Bài 11. Định dạng văn bản": { "NB": ["1.1 Nhận biết được tác dụng của công cụ căn lề, định dạng, tìm kiếm, thay thế trong phần mềm soạn thảo văn bản.", "1.2 Nêu được các chức năng đặc trưng của những phần mềm soạn thảo văn bản."], "VD": ["3.1 Thực hiện được việc định dạng văn bản, trình bày trang văn bản và in."], "VDC": ["4.1 Soạn thảo được văn bản phục vụ học tập và sinh hoạt hàng ngày."] }, "Bài 12. Trình bày thông tin ở dạng bảng": { "VD": ["3.2 Trình bày được thông tin ở dạng bảng."] }, "Bài 13. Thực hành: Tìm kiếm và thay thế": { "VD": ["3.3 Sử dụng được công cụ tìm kiếm và thay thế của phần mềm soạn thảo."] }, "Bài 14. Thực hành tổng hợp: Hoàn thiện sổ lưu niệm": { "VDC": ["4.1 Hoàn thiện được một sổ lưu niệm của lớp/nhóm dưới sự hướng dẫn của giáo viên, bao gồm văn bản và hình ảnh, định dạng các trang văn bản và in."] }, "Bài 15. Thuật toán": { "NB": ["1.1 Nêu được khái niệm thuật toán."], "TH": ["2.1 Nêu được một vài ví dụ minh hoạ về thuật toán."] }, "Bài 16. Các cấu trúc điều khiển": { "VD": ["3.1 Mô tả được thuật toán đơn giản có các cấu trúc tuần tự, rẽ nhánh và lặp dưới dạng liệt kê hoặc sơ đồ khối."] }, "Bài 17. Chương trình máy tính": { "NB": ["1.2 Biết được chương trình là mô tả một thuật toán để máy tính “hiểu” và thực hiện được."] } }, "7": { "Bài 1: Thiết bị vào - ra": { "NB": ["1.1 Biết và nhận ra được các thiết bị vào/ra trong mô hình máy tính, tính đa dạng và hình dạng (chuột, bàn phím, màn hình, loa, cảm ứng, máy quét, camera, …).", "1.2 Biết được chức năng của một số thiết bị vào/ra trong thu thập, lưu trữ, xử lí và truyền thông tin."], "TH": ["2.1 Nêu ví dụ cụ thể về thao tác không đúng gây lỗi cho thiết bị hoặc hệ thống."], "VD": ["3.1 Thực hiện đúng các thao tác với thiết bị thông dụng."] }, "Bài 2: Phần mềm máy tính": { "NB": ["1.1 Nêu được tên một số phần mềm ứng dụng (luyện gõ phím, Word, Paint, …)."], "TH": ["2.1 Giải thích chức năng điều khiển của hệ điều hành, phân biệt với phần mềm ứng dụng.", "2.2 Phân biệt được loại tệp qua phần mở rộng."] }, "Bài 3: Quản lí dữ liệu trong máy tính": { "NB": ["1.1 Biết tệp chương trình cũng là dữ liệu, có thể lưu trữ trong máy tính.", "1.2 Nêu được một số biện pháp bảo vệ máy tính, tài khoản và dữ liệu cá nhân (mật khẩu, đăng xuất, sao lưu, quét virus…).", "1.3 Nêu được cách tổ chức thông tin trong máy tính: tệp, thư mục, đường dẫn."], "VD": ["3.1 Thao tác thành thạo với tệp và thư mục."] }, "Bài 4: Mạng xã hội và một số kênh trao đổi thông tin trên Internet": { "NB": ["1.1 Nhận biết một số website là mạng xã hội (Facebook, YouTube, Zalo, Instagram…).", "1.2 Nêu được tên kênh và thông tin chính (YouTube chia sẻ video; Website trường cung cấp thông tin giáo dục…).", "1.3 Nêu chức năng cơ bản của mạng xã hội: kết nối, giao lưu, chia sẻ, thảo luận, trao đổi thông tin."], "TH": ["2.1 Nêu ví dụ cụ thể về hậu quả khi sử dụng thông tin sai mục đích."], "VD": ["3.1 Sử dụng được một số chức năng cơ bản: tạo tài khoản, hồ sơ, kết nối bạn học, chia sẻ tài liệu, tạo nhóm trao đổi."] }, "Bài 5: Ứng xử trên mạng": { "NB": ["1.1 Biết tác hại của bệnh nghiện Internet.", "1.2 Nêu cách ứng xử hợp lí khi gặp thông tin xấu, không phù hợp lứa tuổi."], "TH": ["2.1 Nêu ví dụ về truy cập không hợp lệ vào nguồn thông tin/kênh truyền thông."], "VD": ["3.1 Biết nhờ người lớn tư vấn khi bị bắt nạt trên mạng.", "3.2 Lựa chọn biện pháp phòng tránh nghiện Internet."], "VDC": ["4.1 Thực hiện giao tiếp trực tuyến đúng quy tắc, lịch sự, có văn hoá."] }, "Bài 6: Làm quen với phần mềm bảng tính": { "NB": ["1.1 Nêu chức năng cơ bản của phần mềm bảng tính."], "VD": ["3.1 Thực hiện thao tác đơn giản với trang tính."] }, "Bài 7: Tính toán tự động trên bảng tính": { "TH": ["2.1 Giải thích việc dùng công thức trong bảng tính là cách tính toán tự động trên dữ liệu."] }, "Bài 8: Công cụ hỗ trợ tính toán": { "VD": ["3.1 Sử dụng được công cụ hỗ trợ tính toán. "] }, "Bài 9: Trình bày bảng tính": { "VD": ["3.2 Thực hiện phép toán thông dụng; sử dụng hàm đơn giản: MAX, MIN, SUM, AVERAGE, COUNT, …"] }, "Bài 10: Hoàn thiện bảng tính": { "VD": ["3.3 Sử dụng công thức và địa chỉ ô, tạo bảng tính có số liệu tính toán bằng công thức."], "VDC": ["4.1 Sử dụng bảng tính để giải quyết một số công việc học tập, đời sống đơn giản."] }, "Bài 11: Tạo bài trình chiếu": { "NB": ["1.1 Nêu chức năng cơ bản của phần mềm trình chiếu."], "VD": ["3.1 Tạo báo cáo có tiêu đề, cấu trúc phân cấp, ảnh minh hoạ, hiệu ứng động."] }, "Bài 12: Định dạng đối tượng trên trang chiếu": { "VD": ["3.2 Sử dụng định dạng văn bản, ảnh minh hoạ và hiệu ứng hợp lí.", "3.3 Sao chép dữ liệu từ văn bản sang trang trình chiếu."] }, "Bài 13: Thực hành tổng hợp: Hoàn thiện bài trình chiếu": { "VDC": ["4.1 Hoàn thiện được một bài trình chiếu theo yêu cầu dưới sự hướng dẫn của giáo viên."] }, "Bài 14: Thuật toán tìm kiếm tuần tự": { "NB": ["1.1 Nêu ý nghĩa của việc chia một bài toán thành bài toán nhỏ."], "TH": ["2.1 Giải thích một vài thuật toán tìm kiếm cơ bản bằng bước thủ công.", "2.2 Giải thích mối liên quan giữa tìm kiếm, nêu ví dụ minh hoạ."], "VD": ["3.1 Biểu diễn và mô phỏng hoạt động của thuật toán tìm kiếm trên bộ dữ liệu nhỏ."] }, "Bài 15: Thuật toán tìm kiếm nhị phân": { "TH": ["2.3 Giải thích một vài thuật toán tìm kiếm cơ bản bằng bước thủ công.", "2.4 Giải thích mối liên quan giữa tìm kiếm, nêu ví dụ minh hoạ."], "VD": ["3.2 Biểu diễn và mô phỏng hoạt động của thuật toán tìm kiếm trên bộ dữ liệu nhỏ."] }, "Bài 16: Thuật toán sắp xếp": { "TH": ["2.5 Giải thích một vài thuật toán sắp xếp bằng bước thủ công.", "2.6 Giải thích mối liên quan giữa sắp xếp, nêu ví dụ minh hoạ."], "VD": ["3.3 Biểu diễn và mô phỏng hoạt động của thuật toán sắp xếp trên bộ dữ liệu nhỏ."] } }, "8": { "Bài 1: Lược sử công cụ tính toán": { "NB": ["1.1 Trình bày được sơ lược lịch sử phát triển máy tính."], "TH": ["2.1 Nêu được ví dụ cho thấy sự phát triển máy tính đem lại thay đổi lớn cho xã hội."] }, "Bài 2: Thông tin trong môi trường số": { "NB": ["1.1 Nêu được các đặc điểm của thông tin số: đa dạng, thu thập nhanh và nhiều, dung lượng lớn, có bản quyền, độ tin cậy khác nhau, có công cụ tìm kiếm/chuyển đổi/truyền/xử lí hiệu quả."], "TH": ["2.1 Nêu ví dụ minh hoạ sử dụng công cụ tìm kiếm, xử lí, trao đổi thông tin trong môi trường số.", "2.2 Trình bày được tầm quan trọng của việc biết khai thác các nguồn thông tin đáng tin cậy, có ví dụ minh hoạ."] }, "Bài 3: Thực hành: Khai thác thông tin số": { "TH": ["2.2 Xác định được lợi ích của thông tin tìm được trong giải quyết vấn đề, có ví dụ minh hoạ."], "VD": ["3.1 Sử dụng được công cụ tìm kiếm, xử lí và trao đổi thông tin trong môi trường số.", "3.2 Chủ động tìm kiếm thông tin để thực hiện nhiệm vụ học tập (qua bài tập cụ thể)."] }, "Bài 4: Đạo đức và văn hóa trong sử dụng công nghệ kĩ thuật số": { "TH": ["2.1 Nhận biết và giải thích được một số biểu hiện vi phạm đạo đức, pháp luật, thiếu văn hoá khi dùng công nghệ số (quay phim/chụp ảnh trái phép, dùng sản phẩm vi phạm bản quyền…).", "2.2 Nêu được ví dụ về truy cập không hợp lệ vào nguồn thông tin/kênh truyền thông."], "VD": ["3.1 Khi tạo sản phẩm số luôn thể hiện tính đạo đức, văn hoá và tuân thủ pháp luật."] }, "Bài 5: Sử dụng bảng tính giải quyết bài toán thực tế": { "TH": ["2.1 Giải thích sự khác nhau giữa địa chỉ tương đối và địa chỉ tuyệt đối của ô tính.", "2.2 Giải thích sự thay đổi địa chỉ tương đối khi sao chép công thức."], "VD": ["3.1 Sao chép dữ liệu từ tệp văn bản, trang trình chiếu sang trang tính."] }, "Bài 6: Sắp xếp và lọc dữ liệu": { "VD": ["3.2 Lọc và sắp xếp dữ liệu.", "3.3 Nêu được tình huống thực tế cần sử dụng chức năng sắp xếp và lọc dữ liệu."], "VDC": ["4.1 Sử dụng được phần mềm bảng tính để giải quyết bài toán thực tế."] }, "Bài 7: Trình bày dữ liệu bằng biểu đồ": { "VD": ["3.4 Thực hiện được thao tác tạo biểu đồ.", "3.5 Nêu được tình huống thực tế cần sử dụng chức năng vẽ biểu đồ."] }, "Bài 8a: Làm việc với danh sách dạng liệt kê và hình ảnh trong văn bản": { "VD": ["3.1 Thực hiện được các thao tác: Chèn thêm, xoá bỏ, co dãn hình ảnh.", "3.2 Vẽ hình đồ hoạ trong văn bản.", "3.3 Tạo danh sách dạng liệt kê."] }, "Bài 8b: Phần mềm chỉnh sửa ảnh": { "VD": ["3.1 Thực hiện được các thao tác chỉnh sửa ảnh đơn giản."] }, "Bài 9a: Tạo đầu trang, chân trang cho văn bản": { "VD": ["3.1 Thực hiện được thao tác đánh số trang, thêm đầu trang và chân trang."] }, "Bài 9b: Thay đổi khung hình, kích thước ảnh": { "VD": ["3.1 Thay đổi được khung hình, kích thước của một ảnh cho trước."] }, "Bài 10a: Định dạng nâng cao cho trang chiếu": { "VD": ["3.1 Chọn đặt được màu sắc, cỡ chữ hài hoà, hợp lí với nội dung."] }, "Bài 10b: Thêm văn bản, tạo hiệu ứng cho ảnh": { "VD": ["3.1 Thêm được các hiệu ứng động đơn giản cho văn bản và ảnh."] }, "Bài 11a: Sử dụng văn bản mẫu tạo bài trình chiếu": { "VD": ["3.2 Sử dụng các bản mẫu (template) để tạo bài trình chiếu."] }, "Bài 11b: Thực hành tổng hợp": { "VDC": ["4.1 Tạo được các sản phẩm số bằng phần mềm trình chiếu phục vụ học tập, giao lưu và trao đổi thông tin."] }, "Bài 12: Từ thuật toán đến chương trình": { "TH": ["2.1 Hiểu được chương trình là dãy các lệnh điều khiển máy tính thực hiện một thuật toán."], "VD": ["3.1 Mô tả được kịch bản đơn giản dưới dạng thuật toán và tạo được một chương trình đơn giản."] }, "Bài 13: Biểu diễn dữ liệu": { "NB": ["1.1 Biết được bit là đơn vị nhỏ nhất trong lưu trữ thông tin.", "1.2 Nêu được tên và độ lớn của các đơn vị cơ bản đo dung lượng thông tin."], "TH": ["2.1 Giải thích được có thể biểu diễn thông tin chỉ với hai kí hiệu 0 và 1."] }, "Bài 14: Cấu trúc điều khiển": { "VD": ["3.1 Thể hiện được cấu trúc tuần tự, rẽ nhánh và lặp ở chương trình trong môi trường lập trình trực quan."] }, "Bài 15: Gỡ lỗi": { "VDC": ["4.1 Chạy thử, tìm lỗi và sửa được lỗi cho chương trình."] }, "Bài 16: Tin học với nghề nghiệp": { "NB": ["1.1 Nêu được một số nghề nghiệp mà ứng dụng tin học sẽ làm tăng hiệu quả công việc.", "1.2 Nêu được tên một số nghề thuộc lĩnh vực tin học và một số nghề liên quan đến ứng dụng tin học."], "TH": ["2.1 Nhận thức và trình bày được vấn đề bình đẳng giới trong việc sử dụng máy tính và trong ứng dụng tin học, nêu được ví dụ minh hoạ."] } }, "9": { "Bài 1. Thế giới kĩ thuật số": { "NB": ["1.1 Nêu được khả năng của máy tính và chỉ ra được một số ứng dụng thực tế của nó trong khoa học kĩ thuật và đời sống."], "TH": ["2.1 Nhận biết được sự có mặt của các thiết bị có gắn bộ xử lí thông tin ở khắp nơi (trong gia đình, ở trường học, cửa hàng, bệnh viện, công sở, nhà máy,...), trong mọi lĩnh vực (y tế, ngân hàng, hàng không, toán học, sinh học,...), nêu được ví dụ minh hoạ.", "2.2 Giải thích được tác động của công nghệ thông tin lên giáo dục và xã hội thông qua các ví dụ cụ thể."] }, "Bài 2. Thông tin trong giải quyết vấn đề": { "TH": ["2.1 Giải thích được sự cần thiết phải quan tâm đến chất lượng thông tin khi tìm kiếm, tiếp nhận và trao đổi thông tin. Nêu được ví dụ minh hoạ.", "2.2 Giải thích được tính mới, tính chính xác, tính đầy đủ, tính sử dụng được của thông tin. Nêu được ví dụ minh hoạ."] }, "Bài 3. Thực hành: Đánh giá chất lượng thông tin": { "VD": ["3.1 Đánh giá được mức độ tin cậy của một nguồn thông tin số.", "3.2 Thực hành đánh giá các nguồn thông tin trên Internet."] }, "Bài 4. Một số vấn đề pháp lí về sử dụng dịch vụ Internet": { "NB": ["1.1 Nêu được một số nội dung liên quan đến luật Công nghệ thông tin, nghị định về sử dụng dịch vụ Internet, các khía cạnh pháp lí của việc sở hữu, sử dụng và trao đổi thông tin."], "TH": ["2.1 Trình bày được một số tác động tiêu cực của công nghệ kĩ thuật số đối với đời sống con người và xã hội, nêu được ví dụ minh hoạ.", "2.2 Nêu được một số hành vi vi phạm pháp luật, trái đạo đức, thiếu văn hoá khi hoạt động trong môi trường số thông qua một vài ví dụ."] }, "Bài 5. Tìm hiểu phần mềm mô phỏng": { "TH": ["2.1 Nêu được ví dụ phần mềm mô phỏng."] }, "Bài 6. Thực hành: Khai thác phần mềm mô phỏng": { "NB": ["1.1 Nêu được những kiến thức đã thu nhận từ việc khai thác một vài phần mềm mô phỏng.", "1.2 Nhận biết được sự mô phỏng thế giới thực nhờ máy tính có thể giúp con người khám phá tri thức và giải quyết vấn đề."] }, "Bài 7. Trình bày thông tin trong trao đổi và hợp tác": { "NB": ["1.1 Biết được khả năng đính kèm văn bản, ảnh, video, trang tính vào sơ đồ tư duy."], "VDC": ["4.1 Sử dụng được bài trình chiếu và sơ đồ tư duy trong trao đổi thông tin và hợp tác."] }, "Bài 8. Thực hành: Sử dụng công cụ trực quan trình bày thông tin trong trao đổi và hợp tác": { "VD": ["3.1 Sử dụng được hình ảnh, biểu đồ, video trong trao đổi thông tin và hợp tác."] }, "Bài 9a. Sử dụng công cụ xác thực dữ liệu": { "VDC": ["4.1 Thực hiện được dự án sử dụng bảng tính điện tử góp phần giải quyết một bài toán liên quan đến quản lí tài chính, dân số,... Ví dụ: quản lí chi tiêu của gia đình, quản lí thu chi quỹ lớp."] }, "Bài 10a. Sử dụng hàm COUNTIF": { "VDC": ["4.1 Thực hiện được dự án sử dụng bảng tính điện tử góp phần giải quyết một bài toán liên quan đến quản lí tài chính, dân số,... Ví dụ: quản lí chi tiêu của gia đình, quản lí thu chi quỹ lớp."] }, "Bài 11a. Sử dụng hàm SUMIF": { "VDC": ["4.1 Thực hiện được dự án sử dụng bảng tính điện tử góp phần giải quyết một bài toán liên quan đến quản lí tài chính, dân số,... Ví dụ: quản lí chi tiêu của gia đình, quản lí thu chi quỹ lớp."] }, "Bài 12a. Sử dụng hàm IF": { "VDC": ["4.1 Thực hiện được dự án sử dụng bảng tính điện tử góp phần giải quyết một bài toán liên quan đến quản lí tài chính, dân số,... Ví dụ: quản lí chi tiêu của gia đình, quản lí thu chi quỹ lớp."] }, "Bài 13a. Hoàn thiện bảng tính quản lí tài chính gia đình": { "VDC": ["4.1 Hoàn thiện được bảng tính quản lí chi tiêu cho một hộ gia đình.", "4.1 Thực hiện được dự án sử dụng bảng tính điện tử góp phần giải quyết một bài toán liên quan đến quản lí tài chính, dân số,... Ví dụ: quản lí chi tiêu của gia đình, quản lí thu chi quỹ lớp."] }, "Bài 9b. Các chức năng chính của phần mềm làm video": { "NB": ["1.1 Nêu được một số chức năng cơ bản của phần mềm làm video."], "TH": ["2.1 Mô tả được quy trình tạo ra một video."] }, "Bài 10b. Chuẩn bị dữ liệu và dựng video": { "VD": ["3.1 Chuẩn bị được các dữ liệu: văn bản, hình ảnh, video, nhạc nền, thuyết minh,…", "3.2 Dựng được video ngắn (1-2 phút) có phụ đề."] }, "Bài 11b. Thực hành: Dựng video theo kịch bản": { "VD": ["3.3 Dựng được video ngắn (1-2 phút) có phụ đề theo một kịch bản cho trước."] }, "Bài 12b. Hoàn thành việc dựng video": { "VD": ["3.4 Hoàn thành được một video ngắn: chèn hiệu ứng, chuyển cảnh, thêm nhạc nền, thuyết minh, phụ đề."] }, "Bài 13b. Biên tập và xuất video": { "VDC": ["4.1 Biên tập và xuất được một video ngắn (1-2 phút) phục vụ một nhiệm vụ cụ thể."] }, "Bài 14. Giải quyết vấn đề": { "NB": ["1.1 Nêu được quy trình con người giao bài toán cho máy tính giải quyết."], "TH": ["2.1 Trình bày được quá trình giải quyết vấn đề và mô tả được giải pháp dưới dạng thuật toán (hoặc bằng phương pháp liệt kê các bước hoặc bằng sơ đồ khối)."] }, "Bài 15. Bài toán tin học": { "TH": ["2.1 Giải thích được trong quy trình giải quyết vấn đề có những bước (những vấn đề nhỏ hơn) có thể chuyển giao cho máy tính thực hiện, nêu được ví dụ minh hoạ.", "2.2 Giải thích được khái niệm bài toán trong tin học là một nhiệm vụ có thể giao cho máy tính thực hiện, nêu được ví dụ minh hoạ."] }, "Bài 16. Thực hành: Lập chương trình máy tính": { "TH": ["2.1 Giải thích được chương trình là bản mô tả thuật toán bằng ngôn ngữ mà máy tính có thể “hiểu” và thực hiện."], "VD": ["3.1 Sử dụng được cấu trúc tuần tự, rẽ nhánh, lặp trong mô tả thuật toán."] }, "Bài 17. Tin học và thế giới nghề nghiệp": { "NB": ["1.1 Trình bày được công việc đặc thù và sản phẩm chính của người làm tin học trong ít nhất ba nhóm nghề.", "1.2 Nhận biết được đặc trưng cơ bản của nhóm nghề thuộc hướng Tin học ứng dụng và nhóm nghề thuộc hướng Khoa học máy tính."], "TH": ["2.1 Nêu và giải thích được ý kiến cá nhân (thích hay không thích,...) về một nhóm nghề nào đó.", "2.2 Giải thích được cả nam và nữ đều có thể thích hợp với các ngành nghề trong lĩnh vực tin học, nêu được ví dụ minh hoạ."], "VD": ["3.1 Tìm hiểu được (thông qua Internet và những kênh thông tin khác) công việc ở một số doanh nghiệp, công ti có sử dụng nhân lực thuộc các nhóm ngành đã được giới thiệu."] } } },

        // --- CUSTOM ALERT MODAL ---
        showAlert(message, title = "Thông báo") {
            const modal = document.getElementById('alert-modal');
            if (modal) {
                document.getElementById('alert-modal-title').textContent = title;
                document.getElementById('alert-modal-message').textContent = message;
                modal.classList.add('is-visible');
            }
        },
        closeAlertModal() {
            const modal = document.getElementById('alert-modal');
            if(modal) modal.classList.remove('is-visible');
        },

        // --- UI UPDATE FUNCTIONS ---
        updateBaiOptions() { 
            const khoiSelect = document.getElementById('khoi');
            const baiSelect = document.getElementById('bai');
            const selectedKhoi = khoiSelect.value; 
            baiSelect.innerHTML = ''; 
            if (selectedKhoi && this.lessonData[selectedKhoi]) { 
                baiSelect.disabled = false; 
                const defaultOption = document.createElement('option'); 
                defaultOption.value = ""; 
                defaultOption.textContent = "-- Chọn bài --"; 
                baiSelect.appendChild(defaultOption); 
                const lessons = this.lessonData[selectedKhoi]; 
                lessons.forEach(lesson => { 
                    const option = document.createElement('option'); 
                    option.value = lesson; 
                    option.textContent = lesson; 
                    if (lesson.startsWith('a. ') || lesson.startsWith('b. ')) { 
                        option.disabled = true; 
                        option.style.fontWeight = 'bold'; 
                        option.style.backgroundColor = '#f0f0f0'; 
                    } 
                    baiSelect.appendChild(option); 
                }); 
            } else { 
                baiSelect.disabled = true; 
                const defaultOption = document.createElement('option'); 
                defaultOption.value = ""; 
                defaultOption.textContent = "-- Vui lòng chọn khối trước --"; 
                baiSelect.appendChild(defaultOption); 
            } 
            this.updateAllCriteria(); 
            this.updateQuestionSummary(); 
            this.updateDacTaPanel();
        },
        updateCriteriaOptions(questionContainer) { 
            const selectedKhoi = document.getElementById('khoi').value;
            const selectedBai = document.getElementById('bai').value;
            const selectedLevel = questionContainer.querySelector('select[name="cognitive-level"]').value;
            const criteriaSelect = questionContainer.querySelector('select[name="criteria"]'); 
            criteriaSelect.innerHTML = ''; 
            let currentCriteria;
            if (selectedBai.includes('a.') || selectedBai.includes('b.')) {
                // For nested lessons
                currentCriteria = this.criteriaData[selectedKhoi]?.[selectedBai]?.[selectedLevel];
            } else {
                // For top-level lessons
                currentCriteria = this.criteriaData[selectedKhoi]?.[selectedBai]?.[selectedLevel];
            }
            
            if (currentCriteria) { 
                const defaultOption = document.createElement('option'); 
                defaultOption.value = ""; 
                defaultOption.textContent = "-- Chọn tiêu chí --"; 
                criteriaSelect.appendChild(defaultOption); 
                currentCriteria.forEach(criterion => { 
                    const option = document.createElement('option'); 
                    const criterionCode = criterion.split(' ')[0]; 
                    option.value = criterionCode; 
                    option.textContent = criterion; 
                    criteriaSelect.appendChild(option); 
                }); 
            } else { 
                const defaultOption = document.createElement('option'); 
                defaultOption.value = ""; 
                defaultOption.textContent = "-- Không có dữ liệu tiêu chí --"; 
                criteriaSelect.appendChild(defaultOption); 
            } 
        },
        updateAllCriteria() { 
            document.querySelectorAll('.question-container').forEach(qc => this.updateCriteriaOptions(qc)); 
            this.updateQuestionSummary(); 
        },
        updateDacTaPanel() {
            const panel = document.getElementById('dac-ta-panel-content');
            if (!panel) return;

            const khoi = document.getElementById('khoi').value;
            const bai = document.getElementById('bai').value;

            panel.innerHTML = ''; // Clear previous content

            if (!khoi || !bai) {
                panel.innerHTML = '<p>Vui lòng chọn khối và bài để xem yêu cầu cần đạt.</p>';
                return;
            }

            const baiData = this.criteriaData[khoi]?.[bai];

            if (!baiData || Object.keys(baiData).length === 0) {
                panel.innerHTML = '<p>Không có dữ liệu đặc tả cho bài này.</p>';
                return;
            }

            let htmlContent = '';
            const levelOrder = ['NB', 'TH', 'VD', 'VDC'];
            const levelNames = {
                'NB': 'Nhận biết',
                'TH': 'Thông hiểu',
                'VD': 'Vận dụng',
                'VDC': 'Vận dụng cao'
            };

            levelOrder.forEach(level => {
                if (baiData[level]) {
                    htmlContent += `<div class="dac-ta-level"><h4>${levelNames[level]}</h4>`;
                    htmlContent += '<ul class="dac-ta-list">';
                    baiData[level].forEach(criterion => {
                        htmlContent += `<li>${criterion.replace(/^\d+\.\d+\s/, '')}</li>`;
                    });
                    htmlContent += '</ul></div>';
                }
            });
            
            if(htmlContent === ''){
                 panel.innerHTML = '<p>Không có dữ liệu đặc tả cho bài này.</p>';
            } else {
                 panel.innerHTML = htmlContent;
            }
        },
        updateQuestionSummary() { 
            const summary = {}; 
            const baiSelect = document.getElementById('bai'); 
            if (!baiSelect.value) { 
                document.getElementById('question-summary').textContent = "Vui lòng chọn bài để xem thống kê."; 
                return; 
            } 
            const baiNumber = this.getBaiNumber(baiSelect); 
            if (!baiNumber) { 
                document.getElementById('question-summary').textContent = "Đang chờ định nghĩa câu hỏi..."; 
                return; 
            } 
            document.querySelectorAll('.question-container').forEach(question => { 
                const level = question.querySelector('select[name="cognitive-level"]').value, 
                      criterion = question.querySelector('select[name="criteria"]').value; 
                if (criterion) { 
                    const key = `B${baiNumber}-${level}-${criterion}`; 
                    summary[key] = (summary[key] || 0) + 1; 
                } 
            }); 
            const summaryDiv = document.getElementById('question-summary'); 
            let outputText = ""; 
            for (const key in summary) { 
                outputText += `${key}: ${summary[key]}\n`; 
            } 
            summaryDiv.textContent = outputText || "Chưa có câu hỏi nào được định nghĩa đầy đủ (thiếu tiêu chí)."; 
        },
        debounceParse(textareaElement) { 
            clearTimeout(this.debounceTimer); 
            this.debounceTimer = setTimeout(() => { this.parseQuestion(textareaElement); }, 500); 
        },
        getBaiNumber(baiSelect) { 
            const selectedBaiText = baiSelect.options[baiSelect.selectedIndex]?.text; 
            if (!selectedBaiText) return null; 
            const baiNumberMatch = selectedBaiText.match(/Bài (\d+)|(\d+\w)/); 
            return baiNumberMatch ? (baiNumberMatch[1] || baiNumberMatch[2]) : null; 
        },
        
        // --- QUESTION MANAGEMENT ---
        parseQuestion(textareaElement) {
            const questionContainer = textareaElement.closest('.question-container');
            if (!questionContainer) return;
            const fullText = textareaElement.value;
            const lines = fullText.split(/\r?\n/).filter(line => line.trim() !== '');
            const fillInTheBlankPattern = /\.{3,}|_{3,}/;
            if (lines.length === 1 && fillInTheBlankPattern.test(fullText)) {
                const questionTypeSelect = questionContainer.querySelector('select[name="question-type"]');
                questionTypeSelect.value = 'fill-blank';
                questionTypeSelect.dispatchEvent(new Event('change'));
                return;
            }
            if (lines.length < 2) return;
            const questionLine = lines[0];
            const optionLines = lines.slice(1);
            const hasValidOption = optionLines.some(line => /^\s*\*?[A-Da-d][.)]/.test(line.trim()));
            if (!hasValidOption && optionLines.length > 0) { return; }
            const optionInputs = questionContainer.querySelectorAll('.option-text');
            const optionCheckboxes = questionContainer.querySelectorAll('.correct-checkbox');
            optionInputs.forEach(input => input.value = '');
            optionCheckboxes.forEach(checkbox => checkbox.checked = false);
            optionLines.forEach((line, index) => {
                if (index < optionInputs.length) {
                    const isCorrect = line.trim().startsWith('*');
                    let cleanText = line.trim();
                    if (isCorrect) cleanText = cleanText.substring(1).trim();
                    cleanText = cleanText.replace(/^[A-Da-d][.)]\s*/, '').trim();
                    optionInputs[index].value = cleanText;
                    optionCheckboxes[index].checked = isCorrect;
                }
            });
            textareaElement.value = questionLine;
            this.updateQuestionSummary();
        },
        addMultipleChoiceQuestion() { 
            this.mcQuestionCount++; 
            const container = document.getElementById('multiple-choice-questions'); 
            const questionDiv = document.createElement('div'); 
            questionDiv.className = 'question-container'; 
            questionDiv.id = `mc-question-${this.mcQuestionCount}`; 
            questionDiv.innerHTML = `<div class="question-header"><div class="question-title">Câu hỏi trắc nghiệm ${this.mcQuestionCount}</div><div class="button-wrapper"><button class="btn btn-danger btn-sm" onclick="App.removeQuestion('mc-question-${this.mcQuestionCount}')"><i class="fa-solid fa-trash-can"></i> Xóa</button></div></div><div class="grid-3"><div class="form-group"><label>Mức độ nhận thức:</label><select name="cognitive-level"><option value="NB">NB - Nhận biết</option><option value="TH">TH - Thông hiểu</option><option value="VD">VD - Vận dụng</option><option value="VDC">VDC - Vận dụng cao</option></select></div><div class="form-group"><label>Tiêu chí (quyết định số câu):</label><select name="criteria"><option value="">-- Chọn các mục trên --</option></select></div><div class="form-group"><label>Loại câu hỏi:</label><select name="question-type"><option value="multiple-choice">Trắc nghiệm nhiều lựa chọn</option><option value="multiple-answer">Trắc nghiệm nhiều đáp án đúng</option><option value="fill-blank">Điền khuyết</option></select></div></div><div class="form-group"><label>Nội dung câu hỏi:</label><textarea name="question-content" placeholder="Dán câu hỏi và các lựa chọn tại đây..."></textarea></div><div class="options-container" id="options-${this.mcQuestionCount}"><label>Các lựa chọn (sẽ được tự động điền):</label><div class="option-group"><input type="checkbox" class="correct-checkbox"><input type="text" class="option-text" placeholder="Lựa chọn A"></div><div class="option-group"><input type="checkbox" class="correct-checkbox"><input type="text" class="option-text" placeholder="Lựa chọn B"></div><div class="option-group"><input type="checkbox" class="correct-checkbox"><input type="text" class="option-text" placeholder="Lựa chọn C"></div><div class="option-group"><input type="checkbox" class="correct-checkbox"><input type="text" class="option-text" placeholder="Lựa chọn D"></div></div><div class="form-group" id="answer-${this.mcQuestionCount}" style="display: none;"><label>Đáp án:</label><input type="text" name="answer" placeholder="Nhập đáp án cho câu điền khuyết..."></div>`; 
            container.appendChild(questionDiv); 
            // Add event listeners for the new elements
            questionDiv.querySelector('select[name="cognitive-level"]').addEventListener('change', () => { this.updateCriteriaOptions(questionDiv); this.updateQuestionSummary(); });
            questionDiv.querySelector('select[name="criteria"]').addEventListener('change', () => this.updateQuestionSummary());
            questionDiv.querySelector('select[name="question-type"]').addEventListener('change', (e) => this.updateQuestionType(e.target, this.mcQuestionCount));
            questionDiv.querySelector('textarea[name="question-content"]').addEventListener('input', (e) => this.debounceParse(e.target));
            questionDiv.querySelectorAll('.correct-checkbox').forEach(cb => cb.addEventListener('change', () => this.updateQuestionSummary()));

            this.updateCriteriaOptions(questionDiv); 
            this.updateQuestionSummary(); 
        },
        addEssayQuestion() { 
            this.essayQuestionCount++; 
            const container = document.getElementById('essay-questions'); 
            const questionDiv = document.createElement('div'); 
            questionDiv.className = 'question-container'; 
            questionDiv.id = `essay-question-${this.essayQuestionCount}`; 
            questionDiv.innerHTML = `<div class="question-header"><div class="question-title">Câu hỏi tự luận ${this.essayQuestionCount}</div><div class="button-wrapper"><button class="btn btn-danger btn-sm" onclick="App.removeQuestion('essay-question-${this.essayQuestionCount}')"><i class="fa-solid fa-trash-can"></i> Xóa</button></div></div><div class="grid-3"><div class="form-group"><label>Mức độ nhận thức:</label><select name="cognitive-level"><option value="NB">NB - Nhận biết</option><option value="TH">TH - Thông hiểu</option><option value="VD">VD - Vận dụng</option><option value="VDC">VDC - Vận dụng cao</option></select></div><div class="form-group"><label>Tiêu chí (quyết định số câu):</label><select name="criteria"><option value="">-- Chọn các mục trên --</option></select></div><div class="form-group"><label>Loại câu hỏi:</label><select name="essay-type"><option value="situation">Tự luận tình huống</option><option value="analysis">Tự luận phân tích</option><option value="explanation">Tự luận giải thích</option><option value="comparison">Tự luận so sánh</option></select></div></div><div class="form-group"><label>Nội dung (có thể bao gồm tình huống và yêu cầu):</label><textarea name="requirements" placeholder="Nhập toàn bộ nội dung câu hỏi tự luận ở đây..."></textarea></div>`; 
            container.appendChild(questionDiv); 
            
            questionDiv.querySelector('select[name="cognitive-level"]').addEventListener('change', () => { this.updateCriteriaOptions(questionDiv); this.updateQuestionSummary(); });
            questionDiv.querySelector('select[name="criteria"]').addEventListener('change', () => this.updateQuestionSummary());

            this.updateCriteriaOptions(questionDiv); 
            this.updateQuestionSummary(); 
        },
        updateQuestionType(select, questionId) { 
            const optionsContainer = document.getElementById(`options-${questionId}`);
            const answerContainer = document.getElementById(`answer-${questionId}`); 
            if (select.value === 'fill-blank') { 
                optionsContainer.style.display = 'none'; 
                answerContainer.style.display = 'block'; 
            } else { 
                optionsContainer.style.display = 'block'; 
                answerContainer.style.display = 'none'; 
            } 
        },
        removeQuestion(questionId) { 
            const element = document.getElementById(questionId); 
            if (element) { 
                element.remove(); 
                this.updateQuestionSummary(); 
            } 
        },
        
        // --- DATA EXPORT FUNCTIONS ---
        generateDocument() {
            document.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
            const validationErrors = [];
            const allQuestions = document.querySelectorAll('.question-container');
            allQuestions.forEach(question => {
                const criteriaSelect = question.querySelector('select[name="criteria"]');
                if (criteriaSelect && !criteriaSelect.value) {
                    const questionTitle = question.querySelector('.question-title').textContent;
                    validationErrors.push(questionTitle);
                    criteriaSelect.classList.add('error-highlight');
                }
            });
            if (validationErrors.length > 0) {
                this.showAlert(`Vui lòng chọn "Tiêu chí" đầy đủ cho các câu hỏi sau:\n- ${validationErrors.join('\n- ')}`);
                return; 
            }
            const baiSelect = document.getElementById('bai');
            const bai = baiSelect.value.trim(); 
            let mcContent = "", essayContent = "", answerKeysContent = ""; 
            const criteriaCounter = {};

            const allQuestionElements = document.querySelectorAll('.question-container');
            
            const mcQuestions = Array.from(allQuestionElements).filter(q => q.id.startsWith('mc-question'));
            const essayQuestions = Array.from(allQuestionElements).filter(q => q.id.startsWith('essay-question'));
            
            if (mcQuestions.length > 0) {
                mcContent += "Phần 1. Trắc nghiệm\n";
                mcQuestions.forEach((question, index) => { 
                    const cognitiveLevel = question.querySelector('select[name="cognitive-level"]').value;
                    const criteria = question.querySelector('select[name="criteria"]').value.trim();
                    const questionContent = question.querySelector('textarea[name="question-content"]').value;
                    
                    let questionNumber;
                    if (criteria) {
                        const counterKey = criteria;
                        criteriaCounter[counterKey] = (criteriaCounter[counterKey] || 0) + 1;
                        questionNumber = `${criteria}.${criteriaCounter[counterKey]}`;
                    } else {
                        questionNumber = `(Chưa có tiêu chí ${index + 1})`;
                    }

                    mcContent += `Câu ${questionNumber} (${cognitiveLevel}): ${questionContent}\n`; 
                    const questionTypeFromSelect = question.querySelector('select[name="question-type"]').value;
                    if (questionTypeFromSelect === 'fill-blank') { 
                        const answer = question.querySelector('input[name="answer"]').value; 
                        if (answer.trim()) answerKeysContent += `${questionNumber}. ${answer}\n`; 
                    } else { 
                        const options = question.querySelectorAll('.option-group');
                        const correctAnswers = [];
                        const checkedCount = question.querySelectorAll('.correct-checkbox:checked').length;
                        const useMultiAnswerFormat = (questionTypeFromSelect === 'multiple-answer' || checkedCount > 1); 
                        options.forEach((option, optionIndex) => { 
                            const isCorrect = option.querySelector('.correct-checkbox').checked;
                            const optionText = option.querySelector('.option-text').value; 
                            if (optionText) { 
                                let finalOptionText = optionText; 
                                const prefixRegex = /^[A-Da-d][.)]\s*/; 
                                let letter; 
                                if (useMultiAnswerFormat) { 
                                    letter = String.fromCharCode(97 + optionIndex); 
                                    if (!prefixRegex.test(optionText)) finalOptionText = `${letter}) ${optionText}`; 
                                    if(isCorrect) correctAnswers.push(letter); 
                                } else { 
                                    letter = String.fromCharCode(65 + optionIndex); 
                                    if (!prefixRegex.test(optionText)) finalOptionText = `${letter}. ${optionText}`; 
                                    if(isCorrect) correctAnswers.push(letter); 
                                } 
                                mcContent += `${isCorrect ? '*' : ''}${finalOptionText}\n`; 
                            } 
                        }); 
                        if (correctAnswers.length > 0) { 
                            if(useMultiAnswerFormat) { 
                                let ds_string = `${questionNumber}: `; 
                                options.forEach((opt, idx) => { 
                                    const optText = opt.querySelector('.option-text').value; 
                                    if(optText) { 
                                        const letter = String.fromCharCode(97 + idx); 
                                        const isCorr = opt.querySelector('.correct-checkbox').checked; 
                                        ds_string += `${letter})${isCorr ? 'Đ' : 'S'} `; 
                                    } 
                                }); 
                                answerKeysContent += ds_string.trim() + '\n'; 
                            } else { 
                                answerKeysContent += `${questionNumber}. ${correctAnswers.join(', ')}\n`; 
                            } 
                        } 
                        mcContent += '\n'; 
                    } 
                }); 
            } 
            
            if (essayQuestions.length > 0) {
                essayContent += "Phần 2. Tự luận\n";
                essayQuestions.forEach((question, index) => { 
                    const cognitiveLevel = question.querySelector('select[name="cognitive-level"]').value;
                    const criteria = question.querySelector('select[name="criteria"]').value.trim();
                    const requirements = question.querySelector('textarea[name="requirements"]').value;
                    
                    let questionNumber;
                    if (criteria) {
                        const counterKey = criteria;
                        criteriaCounter[counterKey] = (criteriaCounter[counterKey] || 0) + 1;
                        questionNumber = `${criteria}.${criteriaCounter[counterKey]}`;
                    } else {
                        questionNumber = `(Chưa có tiêu chí ${index + 1})`;
                    }

                    essayContent += `Câu ${questionNumber} (${cognitiveLevel}):\n${requirements}\n\n`; 
                }); 
            } 

            let finalContent = `${bai}\n\n`; 
            if (mcContent) finalContent += mcContent; 
            if (answerKeysContent) finalContent += "ANSWER KEYS\n" + answerKeysContent + "\n"; 
            if (essayContent) finalContent += essayContent; 
            document.getElementById('output-content').value = finalContent; 
            document.getElementById('output-container').style.display = 'block'; 
            document.getElementById('output-container').scrollIntoView({ behavior: 'smooth' }); 
        },
        exportToJson() {
            const criteriaCounter = {};
            const data = { thongTinChung: { khoi: document.getElementById('khoi').value, bai: document.getElementById('bai').value }, tracNghiem: [], tuLuan: [] }; 
            
            document.querySelectorAll('#multiple-choice-questions .question-container').forEach((q, index) => { 
                const criteria = q.querySelector('select[name="criteria"]').value.trim();
                let questionNumber;
                if (criteria) {
                    const counterKey = criteria;
                    criteriaCounter[counterKey] = (criteriaCounter[counterKey] || 0) + 1;
                    questionNumber = `${criteria}.${criteriaCounter[counterKey]}`;
                } else {
                    questionNumber = `tn-${index + 1}`;
                }
                const originalQuestionNumber = q.dataset.originalNumber || null;
                const questionData = { soCau: questionNumber, tieuChi: criteria, mucDo: q.querySelector('select[name="cognitive-level"]').value, loai: q.querySelector('select[name="question-type"]').value, noiDung: q.querySelector('textarea[name="question-content"]').value, luaChon: [], dapAn: null, originalQuestionNumber: originalQuestionNumber }; 
                if (questionData.loai === 'fill-blank') { 
                    questionData.dapAn = q.querySelector('input[name="answer"]').value; 
                } else { 
                    q.querySelectorAll('.option-group').forEach(opt => { 
                        const text = opt.querySelector('.option-text').value; 
                        if (text) { questionData.luaChon.push({ text: text, correct: opt.querySelector('.correct-checkbox').checked }); } 
                    }); 
                } 
                data.tracNghiem.push(questionData); 
            }); 

            document.querySelectorAll('#essay-questions .question-container').forEach((q, index) => { 
                const criteria = q.querySelector('select[name="criteria"]').value.trim();
                let questionNumber;
                if (criteria) {
                    const counterKey = criteria;
                    criteriaCounter[counterKey] = (criteriaCounter[counterKey] || 0) + 1;
                    questionNumber = `${criteria}.${criteriaCounter[counterKey]}`;
                } else {
                    questionNumber = `tl-${index + 1}`;
                }

                data.tuLuan.push({ soCau: questionNumber, tieuChi: criteria, mucDo: q.querySelector('select[name="cognitive-level"]').value, loai: q.querySelector('select[name="essay-type"]').value, noiDung: q.querySelector('textarea[name="requirements"]').value }); 
            }); 

            const jsonString = JSON.stringify(data, null, 2); 
            const blob = new Blob([jsonString], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            const fileName = (data.thongTinChung.bai || 'bai_tap').replace(/[^a-z0-9]/gi, '_').toLowerCase(); 
            a.download = `${fileName}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
        },
        copyToClipboard() {
            const content = document.getElementById('output-content').value;
            const textArea = document.createElement("textarea");
            textArea.value = content;
            textArea.style.position = "fixed"; // Prevent scrolling to bottom of page in MS Edge.
            textArea.style.top = "0";
            textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const button = document.getElementById('copy-btn');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fa-solid fa-check"></i> Đã sao chép!';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-success');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                    }, 2000);
                } else {
                     this.showAlert('Không thể sao chép nội dung.', 'Lỗi');
                }
            } catch (err) {
                console.error('Không thể sao chép: ', err);
                this.showAlert('Không thể sao chép nội dung.', 'Lỗi');
            }
            document.body.removeChild(textArea);
        },
        
        copyInstructions() {
            const instructionsElement = document.getElementById('bulk-instructions');
            const criteriaElement = document.getElementById('bulk-criteria-list');
            if (!instructionsElement || !criteriaElement) return;

            let instructionsText = instructionsElement.innerText;
            const usageMarker = "TIÊU CHÍ (người dùng sẽ nhập vào sau):";
            const markerIndex = instructionsText.indexOf(usageMarker);
            if (markerIndex !== -1) {
                instructionsText = instructionsText.substring(0, markerIndex).trim();
            }

            const criteriaText = criteriaElement.innerText;
            
            let textToCopy = instructionsText;

            // Append criteria if they are available and valid
            if (criteriaText && !criteriaText.includes("Vui lòng chọn") && !criteriaText.includes("Không có dữ liệu")) {
                 textToCopy += `\n\nTIÊU CHÍ:\n${criteriaText}`;
            }

            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                 if (successful) {
                    const button = document.getElementById('copy-instructions-btn');
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fa-solid fa-check"></i> Đã sao chép!';
                    button.disabled = true;
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    }, 2000);
                } else {
                    this.showAlert('Không thể sao chép hướng dẫn. Vui lòng thử lại.', 'Lỗi');
                }
            } catch (err) {
                console.error('Không thể sao chép: ', err);
                this.showAlert('Không thể sao chép hướng dẫn. Vui lòng thử lại.', 'Lỗi');
            }
            document.body.removeChild(textArea);
        },

        // --- MODAL FUNCTIONS ---
        openBulkAddModal() {
            const criteriaListDiv = document.getElementById('bulk-criteria-list');
            criteriaListDiv.innerHTML = ''; // Clear previous criteria

            const khoi = document.getElementById('khoi').value;
            const bai = document.getElementById('bai').value;

            if (!khoi || !bai) {
                criteriaListDiv.innerHTML = '<p><em>Vui lòng chọn khối và bài trước để xem các tiêu chí gợi ý.</em></p>';
            } else {
                const baiData = this.criteriaData[khoi]?.[bai];
                if (!baiData || Object.keys(baiData).length === 0) {
                    criteriaListDiv.innerHTML = '<p><em>Không có dữ liệu tiêu chí cho bài này.</em></p>';
                } else {
                    let criteriaHtml = '<ul>';
                    const levelOrder = ['NB', 'TH', 'VD', 'VDC'];
                    levelOrder.forEach(level => {
                        if (baiData[level]) {
                            baiData[level].forEach(criterion => {
                                criteriaHtml += `<li>${criterion}</li>`;
                            });
                        }
                    });
                    criteriaHtml += '</ul>';
                    criteriaListDiv.innerHTML = criteriaHtml;
                }
            }
            document.getElementById('bulk-add-modal').classList.add('is-visible');
        },
        closeBulkAddModal() { document.getElementById('bulk-add-modal').classList.remove('is-visible'); },
        
        processBulkQuestions() {
            const existingQuestionMap = new Map();
            document.querySelectorAll('#multiple-choice-questions .question-container[data-original-number]').forEach(qDiv => {
                if (qDiv.dataset.originalNumber) {
                    existingQuestionMap.set(qDiv.dataset.originalNumber, qDiv);
                }
            });

            let rawText = document.getElementById('bulk-textarea').value;
            const answerMap = new Map();
            const answerKeyMarker = 'ANSWER KEYS';
            const answerKeyIndex = rawText.toUpperCase().indexOf(answerKeyMarker);

            if (answerKeyIndex !== -1) {
                const answerKeyText = rawText.substring(answerKeyIndex + answerKeyMarker.length);
                const answerLines = answerKeyText.split('\n');
                answerLines.forEach(line => {
                    const parts = line.match(/^\s*([0-9]+\.[0-9]+(?:\.[0-9]+)?)\s*[:.]\s*(.*)/);
                    if (parts) {
                        let cleanAnswer = parts[2].trim().replace(/^\*?[A-Da-d][.)]\s*/, '').trim();
                        answerMap.set(parts[1], cleanAnswer);
                    }
                });
                rawText = rawText.substring(0, answerKeyIndex);
            }

            const questionBlocks = rawText.split(/\n\s*\n/);
            let addCount = 0;
            let updateCount = 0;
            const parsingErrors = [];
            
            questionBlocks.forEach(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return;

                const lines = trimmedBlock.split('\n');
                let headerLine = lines[0];
                let options = lines.slice(1);
                let criteria = "", level = "", content = "", originalQuestionNumber = "";

                const headerRegex = /^(?:Câu\s*)?([0-9]+\.[0-9]+(?:\.[0-9]+)?)\s*\((NB|TH|VD|VDC)\)[:.]?\s*(.*)/;
                const match = headerLine.match(headerRegex);

                if (match) {
                    originalQuestionNumber = match[1];
                    level = match[2];
                    content = match[3].trim();

                    const numberParts = originalQuestionNumber.split('.');
                    if (numberParts.length >= 2) {
                        criteria = `${numberParts[0]}.${numberParts[1]}`;
                    } else {
                        parsingErrors.push(`Số hiệu không hợp lệ: ${headerLine}`);
                        return;
                    }

                } else {
                    parsingErrors.push(`Sai định dạng: ${headerLine}`);
                    return;
                }
                
                const questionToUpdate = originalQuestionNumber ? existingQuestionMap.get(originalQuestionNumber) : null;

                if (questionToUpdate) {
                    this.populateQuestionForm(questionToUpdate, {criteria, level, content, options, answerMap, originalQuestionNumber});
                    updateCount++;
                    existingQuestionMap.delete(originalQuestionNumber);
                } else {
                    addCount++;
                    const firstQuestion = document.getElementById('mc-question-1');
                    if (firstQuestion && this.mcQuestionCount === 1 && addCount === 1 && firstQuestion.querySelector('textarea[name="question-content"]').value.trim() === '') {
                        firstQuestion.remove();
                        this.mcQuestionCount = 0;
                    }

                    this.addMultipleChoiceQuestion(); 
                    const newQuestionDiv = document.getElementById(`mc-question-${this.mcQuestionCount}`);
                    this.populateQuestionForm(newQuestionDiv, {criteria, level, content, options, answerMap, originalQuestionNumber});
                }
            });

            this.closeBulkAddModal();
            this.updateQuestionSummary();
            
            let alertMessage = `Hoàn tất!\n- Đã thêm mới: ${addCount} câu hỏi.\n- Đã cập nhật: ${updateCount} câu hỏi.`;
            if (parsingErrors.length > 0) {
                alertMessage += `\n\nLưu ý: ${parsingErrors.length} câu hỏi sau không thể xử lý do sai định dạng (cần có dạng 'Câu 2.1 (TH):...'):\n- ${parsingErrors.join('\n- ')}`;
            }
            this.showAlert(alertMessage);
        },
        populateQuestionForm(questionDiv, data) {
            const { criteria, level, content, options, answerMap, originalQuestionNumber } = data;
            
            if (originalQuestionNumber) {
                questionDiv.dataset.originalNumber = originalQuestionNumber;
            }

            const isFillInTheBlank = /_{3,}|\.{3,}/.test(content) || (options.length === 0 && answerMap.has(originalQuestionNumber));
            const correctOptionCount = options.filter(line => line.trim().startsWith('*')).length;
            
            const levelSelect = questionDiv.querySelector('select[name="cognitive-level"]');
            
            if (level) {
                levelSelect.value = level;
                this.updateCriteriaOptions(questionDiv);
            } else {
                this.updateCriteriaOptions(questionDiv);
            }
            
            if (criteria) {
                const criteriaSelect = questionDiv.querySelector('select[name="criteria"]');
                if (criteriaSelect) {
                     criteriaSelect.value = criteria;
                }
            }

            questionDiv.querySelector('textarea[name="question-content"]').value = content;
            const questionTypeSelect = questionDiv.querySelector('select[name="question-type"]');
            if (isFillInTheBlank) {
                questionTypeSelect.value = 'fill-blank';
                if (answerMap.has(originalQuestionNumber)) {
                    questionDiv.querySelector('input[name="answer"]').value = answerMap.get(originalQuestionNumber);
                }
            } else if (correctOptionCount > 1) {
                questionTypeSelect.value = 'multiple-answer';
            } else {
                questionTypeSelect.value = 'multiple-choice';
            }
            this.updateQuestionType(questionTypeSelect, questionDiv.id.split('-').pop());

            const optionInputs = questionDiv.querySelectorAll('.option-text');
            const optionCheckboxes = questionDiv.querySelectorAll('.correct-checkbox');
            optionInputs.forEach(i => i.value = '');
            optionCheckboxes.forEach(c => c.checked = false);
            options.forEach((line, index) => {
                if (index < optionInputs.length) {
                    const isCorrect = line.trim().startsWith('*');
                    let cleanText = line.trim();
                    if (isCorrect) cleanText = cleanText.substring(1).trim();
                    cleanText = cleanText.replace(/^[A-Da-d][.)]\s*/, '').trim();
                    optionInputs[index].value = cleanText;
                    optionCheckboxes[index].checked = isCorrect;
                }
            });
        },
        // --- JSON IMPORT ---
        handleJsonImport(event) {
            const files = event.target.files;
            if (!files.length) return;

            const allTracNghiem = [];
            const allTuLuan = [];
            let thongTinChung = null;
            let filesProcessed = 0;
            const totalFiles = files.length;
            let errors = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.thongTinChung || !data.tracNghiem || !data.tuLuan) {
                            throw new Error(`Cấu trúc không đúng.`);
                        }
                        if (!thongTinChung) {
                            thongTinChung = data.thongTinChung;
                        }
                        allTracNghiem.push(...data.tracNghiem);
                        allTuLuan.push(...data.tuLuan);
                    } catch (error) {
                        errors.push(`File "${file.name}": ${error.message}`);
                    } finally {
                        filesProcessed++;
                        if (filesProcessed === totalFiles) {
                            if (thongTinChung) {
                                this.populateFormFromJson({
                                    thongTinChung: thongTinChung,
                                    tracNghiem: allTracNghiem,
                                    tuLuan: allTuLuan
                                });
                            }
                            let successCount = totalFiles - errors.length;
                            let alertMessage = `Hoàn tất nhập liệu.\n- Thành công: ${successCount} file.\n- Thất bại: ${errors.length} file.`;
                            if (errors.length > 0) {
                                alertMessage += `\n\nChi tiết lỗi:\n- ${errors.join('\n- ')}`;
                            }
                            this.showAlert(alertMessage, 'Kết quả nhập JSON');
                        }
                    }
                };
                reader.onerror = () => {
                    errors.push(`File "${file.name}": Không thể đọc file.`);
                    filesProcessed++;
                    if (filesProcessed === totalFiles) {
                         if (thongTinChung) {
                            this.populateFormFromJson({
                                thongTinChung: thongTinChung,
                                tracNghiem: allTracNghiem,
                                tuLuan: allTuLuan
                            });
                        }
                        let successCount = totalFiles - errors.length;
                        let alertMessage = `Hoàn tất nhập liệu.\n- Thành công: ${successCount} file.\n- Thất bại: ${errors.length} file.`;
                        if (errors.length > 0) {
                            alertMessage += `\n\nChi tiết lỗi:\n- ${errors.join('\n- ')}`;
                        }
                        this.showAlert(alertMessage, 'Kết quả nhập JSON');
                    }
                };
                reader.readAsText(file);
            });
            event.target.value = null; // Reset input
        },
        populateFormFromJson(data) {
            if (!data.thongTinChung || !data.tracNghiem || !data.tuLuan) {
                throw new Error("Cấu trúc file JSON không đúng.");
            }

            document.getElementById('multiple-choice-questions').innerHTML = '';
            document.getElementById('essay-questions').innerHTML = '';
            this.mcQuestionCount = 0;
            this.essayQuestionCount = 0;

            const khoiSelect = document.getElementById('khoi');
            khoiSelect.value = data.thongTinChung.khoi;
            this.updateBaiOptions(); // Directly call the update function

            const baiSelect = document.getElementById('bai');
            baiSelect.value = data.thongTinChung.bai;
            this.updateAllCriteria(); // Update criteria based on the new "bài"
            this.updateDacTaPanel();

            data.tracNghiem.forEach(qData => {
                this.addMultipleChoiceQuestion();
                const newDiv = document.getElementById(`mc-question-${this.mcQuestionCount}`);
                const popData = {
                    criteria: qData.tieuChi,
                    level: qData.mucDo,
                    content: qData.noiDung,
                    options: qData.luaChon.map(opt => `${opt.correct ? '*' : ''}${opt.text}`),
                    answerMap: new Map([[qData.originalQuestionNumber || qData.tieuChi, qData.dapAn]]),
                    originalQuestionNumber: qData.originalQuestionNumber
                };
                this.populateQuestionForm(newDiv, popData);
            });

            data.tuLuan.forEach(qData => {
                this.addEssayQuestion();
                const newDiv = document.getElementById(`essay-question-${this.essayQuestionCount}`);
                newDiv.querySelector('select[name="cognitive-level"]').value = qData.mucDo;
                this.updateCriteriaOptions(newDiv); // Must update criteria before setting its value
                newDiv.querySelector('select[name="criteria"]').value = qData.tieuChi;
                newDiv.querySelector('select[name="essay-type"]').value = qData.loai;
                newDiv.querySelector('textarea[name="requirements"]').value = qData.noiDung;
            });

            this.updateQuestionSummary();
        },
        
        // --- INITIALIZATION ---
        init() {
            // Attach event listeners
            document.getElementById('khoi').addEventListener('change', () => this.updateBaiOptions());
            document.getElementById('bai').addEventListener('change', () => { this.updateAllCriteria(); this.updateQuestionSummary(); this.updateDacTaPanel(); });
            document.getElementById('add-mc-btn').addEventListener('click', () => this.addMultipleChoiceQuestion());
            document.getElementById('bulk-add-btn').addEventListener('click', () => this.openBulkAddModal());
            document.getElementById('add-essay-btn').addEventListener('click', () => this.addEssayQuestion());
            document.getElementById('generate-doc-btn').addEventListener('click', () => this.generateDocument());
            document.getElementById('export-json-btn').addEventListener('click', () => this.exportToJson());
            document.getElementById('copy-btn').addEventListener('click', () => this.copyToClipboard());
            document.getElementById('json-import-input').addEventListener('change', (e) => this.handleJsonImport(e), false);

            // Modal listeners
            document.getElementById('close-bulk-modal-btn').addEventListener('click', () => this.closeBulkAddModal());
            document.getElementById('process-bulk-btn').addEventListener('click', () => this.processBulkQuestions());
            document.getElementById('copy-instructions-btn').addEventListener('click', () => this.copyInstructions());
            document.getElementById('close-alert-btn').addEventListener('click', () => this.closeAlertModal());
            
            // Close modals on outside click
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                window.addEventListener('click', (event) => {
                    if (event.target == modal) {
                        modal.classList.remove('is-visible');
                    }
                });
            });

            // Initial setup
            this.updateQuestionSummary();
            this.updateDacTaPanel();
        }
    };

    // --- START THE APP ---
    // Using DOMContentLoaded is slightly more efficient than onload
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
    </script>
</body>
</html>

