<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Tạo Đề Thi Theo Ma Trận | Công Cụ Quản Lý Đề Thi</title>
    <!-- Thêm thư viện Font Awesome để sử dụng icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- HỆ THỐNG THIẾT KẾ ĐỒNG BỘ --- */
        :root {
            --primary-color: #0056b3;
            --primary-color-light: #007bff;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --background-color: #f4f7fa;
            --card-background: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --font-family: 'Be Vietnam Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            color: var(--text-color);
            font-size: 16px;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: var(--primary-color);
        }
        .header p {
            font-size: 1.1em;
            color: var(--secondary-color);
            max-width: 700px;
            margin: 0 auto;
        }

        .app-view { display: none; }
        .app-view.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- CARD STYLE --- */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* --- BUTTON SYSTEM --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; font-family: var(--font-family); transition: transform 0.2s ease, filter 0.2s ease; }
        .btn:hover { transform: translateY(-2px); filter: brightness(0.95); }
        .btn.btn-lg { padding: 15px 30px; font-size: 1.1rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-info { background-color: var(--info-color); color: var(--text-color); }
        .btn-outline-primary { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); }

        /* --- UPLOAD VIEW --- */
        .upload-section { text-align: center; padding: 40px; border: 2px dashed var(--border-color); border-radius: 12px; background-color: #fafcff; }
        .upload-section p { margin: 10px 0 20px; }
        #fileInput { display: none; }

        /* --- CONFIG VIEW --- */
        .summary-box { padding: 20px; background-color: #e9f5ff; border-left: 5px solid var(--primary-color-light); margin-bottom: 25px; border-radius: 8px; }
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .matrix-table th, .matrix-table td { border: 1px solid var(--border-color); padding: 12px; text-align: center; }
        .matrix-table th { background-color: #f8f9fa; font-weight: 500; }
        .matrix-table .lesson-name { text-align: left; font-weight: 500; }
        .matrix-table input[type="number"] { width: 60px; text-align: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; }
        .matrix-table .available-count { font-size: 0.85em; color: var(--secondary-color); margin-top: 4px;}

        /* --- REVIEW VIEW --- */
        .bulk-point-setter { margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .bulk-point-setter input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .review-question { background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .review-question .content { flex-grow: 1; white-space: pre-wrap; line-height: 1.6; }
        .review-question .actions { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .review-question .point-selector select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .export-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; }
        .modal.is-visible { display: flex; }
        .modal-content { background-color: var(--card-background); margin: auto; padding: 30px; border: none; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease-out; }
        .modal-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--primary-color); font-size: 1.5rem; font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .modal-footer { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <h1><i class="fa-solid fa-wand-magic-sparkles"></i> Trình Tạo Đề Thi Theo Ma Trận</h1>
            <p>Tự động hóa việc tạo đề thi từ ngân hàng câu hỏi và ma trận tùy chỉnh của bạn.</p>
        </header>

        <div id="uploadView" class="app-view active card">
            <h2 class="card-title"><i class="fa-solid fa-1"></i> Bước 1: Tải lên Ngân hàng câu hỏi</h2>
            <div class="upload-section">
                <p>Chọn một hoặc nhiều file JSON chứa câu hỏi của bạn để bắt đầu.</p>
                <input type="file" id="fileInput" accept=".json" multiple>
                <button class="btn btn-primary btn-lg" id="uploadButton"><i class="fa-solid fa-upload"></i> Chọn File JSON</button>
            </div>
        </div>

        <div id="configView" class="app-view card">
            <h2 class="card-title"><i class="fa-solid fa-2"></i> Bước 2: Xây dựng Ma trận Đề thi</h2>
            <div id="configSummary" class="summary-box"></div>
            <table class="matrix-table" id="matrixTable">
                <thead><tr><th>Bài học</th><th>NB</th><th>TH</th><th>VD</th><th>VDC</th></tr></thead>
                <tbody></tbody>
            </table>
            <button id="generateTestButton" class="btn btn-success btn-lg" style="width: 100%; margin-top: 30px;"><i class="fa-solid fa-cogs"></i> Tạo Đề thi Ngẫu nhiên</button>
        </div>

        <div id="reviewView" class="app-view card">
            <h2 class="card-title"><i class="fa-solid fa-3"></i> Bước 3: Rà soát và Xuất bản</h2>
            <div class="bulk-point-setter">
                <label for="bulk-points-input"><strong>Điểm chung cho mỗi câu:</strong></label>
                <input type="number" id="bulk-points-input" step="0.25" value="0.25">
                <button id="apply-bulk-points-btn" class="btn btn-secondary"><i class="fa-solid fa-check-double"></i> Áp dụng cho tất cả</button>
            </div>
            <div id="review-question-bank"></div>
            <div class="export-section">
                <button id="exportWordAzotaButton" class="btn btn-info"><i class="fa-solid fa-file-word"></i> Xuất Word (AZota)</button>
                <button id="exportWordTestButton" class="btn btn-primary"><i class="fa-solid fa-file-word"></i> Xuất Word (Đề thi)</button>
            </div>
        </div>
    </div>

    <!-- Modal Nhập Tiêu Đề -->
    <div id="headerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><i class="fa-solid fa-pen-to-square"></i><h3>Nhập thông tin tiêu đề</h3></div>
            <div class="form-group">
                <label for="donVi">Đơn vị chủ quản</label>
                <input type="text" id="donVi" value="UBND PHƯỜNG HẢI CHÂU">
            </div>
            <div class="form-group">
                <label for="tenTruong">Tên trường</label>
                <input type="text" id="tenTruong" value="TRƯỜNG TRUNG HỌC CƠ SỞ LÊ THÁNH TÔN">
            </div>
            <div class="form-group">
                <label for="tenKyThi">Tên kỳ thi</label>
                <input type="text" id="tenKyThi" value="KIỂM TRA CUỐI KÌ II NĂM HỌC 2024 - 2025">
            </div>
            <div class="form-group">
                <label for="monHoc">Môn học</label>
                <input type="text" id="monHoc" value="Tin học 6">
            </div>
            <div class="form-group">
                <label for="thoiGian">Thời gian</label>
                <input type="text" id="thoiGian" value="45 phút">
            </div>
            <div class="modal-footer">
                <button id="cancelHeaderBtn" class="btn btn-secondary">Huỷ</button>
                <button id="confirmHeaderBtn" class="btn btn-success">Xác Nhận & Xuất</button>
            </div>
        </div>
    </div>
    
    <!-- Modal thông báo tùy chỉnh -->
    <div id="alert-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-header" style="justify-content: center; border-bottom: none;">
                <h2 id="alert-modal-title">Thông báo</h2>
            </div>
            <p id="alert-modal-message" style="margin-bottom: 20px; font-size: 1.1rem; white-space: pre-wrap;"></p>
            <button class="btn btn-primary" onclick="closeAlertModal()" style="width: auto; min-width: 100px;">OK</button>
        </div>
    </div>


    <script>
        // --- CUSTOM ALERT MODAL ---
        function showAlert(message, title = "Thông báo") {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').classList.add('is-visible');
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').classList.remove('is-visible');
        }


        const TestGeneratorApp = {
            state: {
                allQuestions: [],
                availableLessons: {},
                testMatrix: {},
                generatedTest: [],
                view: 'upload',
            },

            init() {
                this.dom = {
                    views: { upload: document.getElementById('uploadView'), config: document.getElementById('configView'), review: document.getElementById('reviewView') },
                    uploadButton: document.getElementById('uploadButton'),
                    fileInput: document.getElementById('fileInput'),
                    configSummary: document.getElementById('configSummary'),
                    matrixTableBody: document.querySelector('#matrixTable tbody'),
                    generateTestButton: document.getElementById('generateTestButton'),
                    reviewQuestionBank: document.getElementById('review-question-bank'),
                    exportAzotaBtn: document.getElementById('exportWordAzotaButton'),
                    exportTestBtn: document.getElementById('exportWordTestButton'),
                    headerModal: document.getElementById('headerModal'),
                    cancelHeaderBtn: document.getElementById('cancelHeaderBtn'),
                    confirmHeaderBtn: document.getElementById('confirmHeaderBtn'),
                    bulkPointsInput: document.getElementById('bulk-points-input'),
                    applyBulkPointsBtn: document.getElementById('apply-bulk-points-btn'),
                };
                
                this.dom.uploadButton.addEventListener('click', () => this.dom.fileInput.click());
                this.dom.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.dom.generateTestButton.addEventListener('click', () => this.generateTest());
                this.dom.exportAzotaBtn.addEventListener('click', () => this.exportTest('azota'));
                this.dom.exportTestBtn.addEventListener('click', () => this.openHeaderModal());
                this.dom.applyBulkPointsBtn.addEventListener('click', () => this.applyBulkPoints());
                this.dom.cancelHeaderBtn.addEventListener('click', () => this.closeHeaderModal());
                this.dom.confirmHeaderBtn.addEventListener('click', () => this.exportTest('test'));

                this.dom.reviewQuestionBank.addEventListener('click', (event) => {
                    const swapButton = event.target.closest('.swap-button');
                    if (swapButton) {
                        const uniqueId = swapButton.dataset.id;
                        this.swapQuestion(uniqueId);
                    }
                });
                this.dom.reviewQuestionBank.addEventListener('change', (event) => {
                    if (event.target && event.target.classList.contains('points-dropdown')) {
                        const uniqueId = event.target.dataset.id;
                        const newPoints = parseFloat(event.target.value);
                        this.updatePoints(uniqueId, newPoints);
                    }
                });
            },

            openHeaderModal() {
                if (this.state.generatedTest.length === 0) return showAlert('Chưa có đề thi nào được tạo để xuất file.');
                this.dom.headerModal.classList.add('is-visible');
            },

            closeHeaderModal() {
                this.dom.headerModal.classList.remove('is-visible');
            },
            
            applyBulkPoints() {
                const points = parseFloat(this.dom.bulkPointsInput.value);
                if (isNaN(points) || points < 0) return showAlert('Vui lòng nhập một số điểm hợp lệ.');
                this.state.generatedTest.forEach(q => q.points = points);
                this.render();
            },
            
            updatePoints(uniqueId, newPoints) {
                const question = this.state.generatedTest.find(q => q.uniqueId == uniqueId);
                if (question) question.points = newPoints;
            },

            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length === 0) return;
                
                const fileReadPromises = Array.from(files).map(file => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => { try { resolve(JSON.parse(e.target.result)); } catch { resolve(null); } };
                    reader.readAsText(file);
                }));

                Promise.all(fileReadPromises).then(allData => {
                    let tempBank = [];
                    allData.forEach(data => {
                        if (!data) return;
                        const bai = data.thongTinChung?.tenBai || data.thongTinChung?.bai || 'Chung';
                        const process = (qList) => qList.forEach(q => tempBank.push({ ...q, bai, uniqueId: Math.random() }));
                        if (data.tracNghiem) process(data.tracNghiem);
                        if (data.tuLuan) process(data.tuLuan);
                    });
                    
                    const seenContent = new Set();
                    this.state.allQuestions = tempBank.filter(q => {
                        const content = (q.noiDung || '').trim();
                        if (seenContent.has(content)) return false;
                        seenContent.add(content);
                        return true;
                    });

                    this.analyzeBank();
                    this.state.view = 'config';
                    this.render();
                });
            },

            analyzeBank() {
                this.state.availableLessons = {};
                this.state.allQuestions.forEach(q => {
                    if (!this.state.availableLessons[q.bai]) {
                        this.state.availableLessons[q.bai] = { NB: 0, TH: 0, VD: 0, VDC: 0 };
                    }
                    if (this.state.availableLessons[q.bai][q.mucDo] !== undefined) {
                        this.state.availableLessons[q.bai][q.mucDo]++;
                    }
                });
            },

            generateTest() {
                this.state.testMatrix = {};
                document.querySelectorAll('#matrixTable tbody tr').forEach(row => {
                    const bai = row.dataset.bai;
                    this.state.testMatrix[bai] = {
                        NB: parseInt(row.querySelector('input[data-level="NB"]').value) || 0,
                        TH: parseInt(row.querySelector('input[data-level="TH"]').value) || 0,
                        VD: parseInt(row.querySelector('input[data-level="VD"]').value) || 0,
                        VDC: parseInt(row.querySelector('input[data-level="VDC"]').value) || 0,
                    };
                });

                this.state.generatedTest = [];
                const shuffle = arr => arr.sort(() => 0.5 - Math.random());
                for (const bai in this.state.testMatrix) {
                    for (const level in this.state.testMatrix[bai]) {
                        const count = this.state.testMatrix[bai][level];
                        if (count > 0) {
                            let pool = this.state.allQuestions.filter(q => q.bai === bai && q.mucDo === level);
                            if (count > pool.length) return showAlert(`Lỗi: Yêu cầu ${count} câu ${level} từ "${bai}" nhưng chỉ có ${pool.length} câu.`);
                            
                            const byType = pool.reduce((acc, q) => { (acc[q.loai] = acc[q.loai] || []).push(q); return acc; }, {});
                            let selected = [];
                            const types = shuffle(Object.keys(byType));
                            types.forEach(type => { if (selected.length < count && byType[type].length > 0) selected.push(byType[type].pop()); });
                            
                            let remainingPool = shuffle(Object.values(byType).flat());
                            while (selected.length < count && remainingPool.length > 0) selected.push(remainingPool.pop());
                            
                            selected.forEach(q => q.points = 0.25);
                            this.state.generatedTest.push(...selected);
                        }
                    }
                }
                this.state.view = 'review';
                this.render();
            },

            swapQuestion(idToSwap) {
                const indexToSwap = this.state.generatedTest.findIndex(q => q.uniqueId == idToSwap);
                if (indexToSwap === -1) return;
                const qToSwap = this.state.generatedTest[indexToSwap];
                const testIds = new Set(this.state.generatedTest.map(q => q.uniqueId));
                
                const pool = this.state.allQuestions.filter(q => 
                    q.bai === qToSwap.bai && 
                    q.mucDo === qToSwap.mucDo && 
                    !testIds.has(q.uniqueId)
                );
                if (pool.length > 0) {
                    this.state.generatedTest[indexToSwap] = { ...pool[Math.floor(Math.random() * pool.length)], points: qToSwap.points };
                    this.render();
                } else {
                    showAlert(`Không còn câu hỏi nào khác cùng bài "${qToSwap.bai}" và mức độ "${qToSwap.mucDo}" để đổi.`);
                }
            },
            
            exportTest(type) {
                if (this.state.generatedTest.length === 0) return showAlert('Chưa có đề thi nào được tạo để xuất file.');
                const generator = type === 'azota' ? this.generateWordAota : this.generateWordTest;
                const { html, filename } = generator.call(this, this.state.generatedTest);
                this.triggerDownload(html, filename);

                if (type === 'test') {
                    this.closeHeaderModal();
                }
            },

            render() {
                Object.values(this.dom.views).forEach(v => v.classList.remove('active'));
                this.dom.views[this.state.view].classList.add('active');

                if (this.state.view === 'config') {
                    const total = Object.values(this.state.availableLessons).reduce((acc, levels) => {
                        Object.keys(levels).forEach(level => acc[level] = (acc[level] || 0) + levels[level]);
                        return acc;
                    }, {NB:0, TH:0, VD:0, VDC:0});
                    this.dom.configSummary.innerHTML = `<p><strong>Ngân hàng đề có:</strong> ${Object.keys(total).map(k => `${k}: ${total[k]}`).join(', ')}.</p>`;
                    this.dom.matrixTableBody.innerHTML = Object.keys(this.state.availableLessons).map(bai => {
                        const levels = this.state.availableLessons[bai];
                        return `<tr data-bai="${bai}"><td class="lesson-name">${bai}</td>
                            ${['NB', 'TH', 'VD', 'VDC'].map(l => `<td><input type="number" data-level="${l}" min="0" max="${levels[l]}" value="0"><div class="available-count">/ ${levels[l]}</div></td>`).join('')}
                        </tr>`;
                    }).join('');
                } else if (this.state.view === 'review') {
                    const pointsOptions = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
                    this.dom.reviewQuestionBank.innerHTML = this.state.generatedTest.map((q, index) => {
                        const optionsHtml = pointsOptions.map(p => `<option value="${p}" ${p === q.points ? 'selected' : ''}>${p.toFixed(2)}</option>`).join('');
                        
                        return `<div class="review-question">
                            <div class="content"><strong>Câu ${index + 1}:</strong> ${q.noiDung}</div>
                            <div class="actions">
                                <div class="point-selector">
                                    <select class="points-dropdown" data-id="${q.uniqueId}">${optionsHtml}</select>
                                </div>
                                <button class="btn btn-outline-primary swap-button" data-id="${q.uniqueId}"><i class="fa-solid fa-arrows-rotate"></i> Đổi</button>
                            </div>
                        </div>`;
                    }).join('');
                }
            },
            
            generateWordAota(questions) {
                let questionContent = questions.map((q, index) => {
                    let questionHtml = `<p style="margin-top: 6pt; margin-bottom: 0; font-size: 13pt;"><strong>Câu ${index + 1} (${(q.points || 0).toFixed(2)} điểm):</strong> ${q.noiDung}</p>`;
                    if (q.luaChon && q.luaChon.length > 0) {
                        const optionsHtml = q.luaChon.map((opt, i) => {
                            const prefix = q.loai === 'multiple-answer' ? `${String.fromCharCode(97 + i)})` : `${String.fromCharCode(65 + i)}.`;
                            return `<div style="margin-left: 20px; font-size: 13pt;">${opt.correct ? '*' : ''}${prefix} ${opt.text}</div>`;
                        }).join('');
                        questionHtml += optionsHtml;
                    }
                    return questionHtml;
                }).join('');

                const answerKeyHtml = this.generateAnswerKeyHtml(questions, 'azota', {});
                const fullHtml = `<div style="font-family: Times New Roman, serif; font-size: 13pt; line-height: 1.5; text-align: justify;">Phần 1. Trắc nghiệm${questionContent}${answerKeyHtml}</div>`;
                return { html: fullHtml, filename: 'dapan_azota.doc' };
            },
            
            generateWordTest(questions) {
                const headerInfo = {
                    donVi: document.getElementById('donVi').value,
                    tenTruong: document.getElementById('tenTruong').value,
                    tenKyThi: document.getElementById('tenKyThi').value,
                    monHoc: document.getElementById('monHoc').value,
                    thoiGian: document.getElementById('thoiGian').value
                };

                const headerHtml = `
                    <table style="width:100%; border: none; font-family: 'Times New Roman', serif; font-size: 13pt; line-height: 1.5;">
                        <tr>
                            <td style="text-align: center; width: 50%; vertical-align: top;">
                                <p style="margin:0; text-transform: uppercase;">${headerInfo.donVi}</p>
                                <table style="margin: 0 auto; border: none; border-collapse: collapse; text-align: center;">
                                    <tr><td style="padding:0 5px; text-transform: uppercase; font-weight: bold;">${headerInfo.tenTruong}</td></tr>
                                </table>
                            </td>
                            <td style="text-align: center; width: 50%; vertical-align: top;">
                                 <p style="margin:0; font-weight: bold; text-transform: uppercase;">${headerInfo.tenKyThi}</p>
                                 <p style="margin:0;"><strong>Môn: ${headerInfo.monHoc}</strong></p>
                                 <p style="margin:0;">Thời gian: ${headerInfo.thoiGian} <em>(không kể thời gian giao đề)</em></p>
                                 <p style="margin:0; font-style: italic;">(Đề có 05 trang)</p>
                            </td>
                        </tr>
                         <tr>
                            <td style="text-align: center; padding-top: 10px;">
                                <p style="margin:0; font-weight: bold;">ĐỀ CHÍNH THỨC</p>
                            </td>
                            <td></td>
                         </tr>
                    </table>
                    <table style="width: 100%; margin-top: 10pt; font-size: 13pt;">
                        <tr>
                            <td style="width: 70%;"><strong>Họ và tên:</strong> .....................................................</td>
                            <td><strong>Lớp:</strong> ......................</td>
                        </tr>
                    </table>`;

                // Phân loại câu hỏi: trắc nghiệm là câu có lựa chọn, tự luận là câu không có.
                const tracNghiemQuestions = questions.filter(q => q.luaChon && q.luaChon.length > 0);
                const tuLuanQuestions = questions.filter(q => !q.luaChon || q.luaChon.length === 0);
                const sortedQuestions = [...tracNghiemQuestions, ...tuLuanQuestions];

                let tracNghiemHtml = '';
                if (tracNghiemQuestions.length > 0) {
                    const tracNghiemTotalPoints = tracNghiemQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
                    
                    const gridQuestionCount = 28;
                    let answerGridHtml = '';

                    answerGridHtml = `<p style="text-align: left; font-style: italic; margin-bottom: 0;">- Em hãy điền đáp án vào khung bên dưới cho câu trả lời đúng: (mỗi câu đúng 0,25 điểm)</p>
                                      <p style="text-align: left; font-style: italic; margin-bottom: 0;">- Trong đề kiểm tra này sử dụng phần mềm MS Office 2016</p>
                                      <table style="border-collapse: collapse; margin: 10pt 0;">`;
                    const cols = 14;
                    const rows = 2; 
                    for (let i = 0; i < rows; i++) {
                        answerGridHtml += '<tr>';
                        for(let j=0; j<cols; j++) { 
                            const num = i * cols + j + 1; 
                            answerGridHtml += `<td style="border: 1px solid black; text-align: center; font-weight: bold; padding: 4px;">Câu ${num}</td>`;
                        }
                        answerGridHtml += '</tr><tr>';
                        for(let j=0; j<cols; j++) { 
                            answerGridHtml += `<td style="border: 1px solid black; height: 20px;"></td>`;
                        }
                        answerGridHtml += '</tr>';
                    }
                    answerGridHtml += '</table>';

                    const questionContent = tracNghiemQuestions.map((q, index) => {
                        let questionHtml = `<p style="margin-top: 6pt; margin-bottom: 0; font-size: 13pt;"><strong>Câu ${index + 1}.</strong> ${q.noiDung}</p>`;
                        if (q.luaChon && q.luaChon.length > 0) {
                            
                            const allOptionsAreShort = q.luaChon.every(opt => (opt.text || '').trim().split(/\s+/).length < 8);

                            let optionsHtml = '';
                            if (allOptionsAreShort) {
                                let tableContent = '<table style="width: 100%; border: none; border-collapse: collapse; table-layout: fixed;">';
                                for (let i = 0; i < q.luaChon.length; i += 2) {
                                    const opt1 = q.luaChon[i];
                                    const opt2 = q.luaChon[i+1];
                                    const prefix1 = `<strong>${String.fromCharCode(65 + i)}.</strong>`;
                                    const prefix2 = opt2 ? `<strong>${String.fromCharCode(65 + i + 1)}.</strong>` : '';
                                    tableContent += `<tr>
                                        <td style="width: 50%; vertical-align: top; padding: 2pt 5pt 2pt 0; font-size: 13pt;">${prefix1} ${opt1.text}</td>
                                        <td style="width: 50%; vertical-align: top; padding: 2pt 0 2pt 5pt; font-size: 13pt;">${opt2 ? `${prefix2} ${opt2.text}` : ''}</td>
                                    </tr>`;
                                }
                                tableContent += '</table>';
                                optionsHtml = `<div style="margin-left: 0.25cm;">${tableContent}</div>`;
                            } else {
                                optionsHtml = q.luaChon.map((opt, i) => {
                                    const prefix = `<strong>${String.fromCharCode(65 + i)}.</strong>`;
                                    return `<div style="margin-left: 20px; padding: 2px 0; font-size: 13pt;">${prefix} ${opt.text}</div>`;
                                }).join('');
                            }
                            questionHtml += optionsHtml;
                        }
                        return questionHtml;
                    }).join('');
                    
                    tracNghiemHtml = `
                        <h3 style="text-align:left; font-weight:bold;">Phần 1. Trắc nghiệm (${tracNghiemTotalPoints.toFixed(1)} điểm)</h3>
                        ${answerGridHtml}
                        ${questionContent}
                    `;
                }
                
                let tuLuanHtml = '';
                if (tuLuanQuestions.length > 0) {
                    const tuLuanTotalPoints = tuLuanQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
                    const questionContent = tuLuanQuestions.map((q, index) => {
                          let questionHtml = `<p style="margin-top: 6pt; margin-bottom: 0; font-size: 13pt;"><strong>Câu ${index + tracNghiemQuestions.length + 1} (${(q.points || 0).toFixed(2)} điểm):</strong> ${q.noiDung}</p>`;
                          const dottedLine = '<p style="font-size: 13pt; margin-top: 6pt; margin-bottom: 0;">.....................................................................................................................................</p>';
                          questionHtml += dottedLine.repeat(5);
                          return questionHtml;
                    }).join('');

                    tuLuanHtml = `
                        <h3 style="text-align:left; font-weight:bold; margin-top: 15pt;">Phần 2. Tự luận (${tuLuanTotalPoints.toFixed(1)} điểm)</h3>
                        ${questionContent}
                    `;
                }
                
                const answerKeyHtml = this.generateAnswerKeyHtml(sortedQuestions, 'test', headerInfo);
                const finalHtml = `<div style="font-family: 'Times New Roman', serif; font-size: 13pt; line-height: 1.5; margin: 0 auto; max-width: 800px; text-align: justify;">
                    ${headerHtml}
                    ${tracNghiemHtml}
                    ${tuLuanHtml}
                    <br/><p style="text-align: center; font-weight: bold;">---HẾT---</p></div><br clear=all style='page-break-before:always'>${answerKeyHtml}`;
                return { html: finalHtml, filename: 'de_thi.doc' };
            },
            
            generateAnswerKeyHtml(questions, type, headerInfo) {
                if (type === 'azota') {
                    let keyHtml = `<div style="font-family: Times New Roman, serif; font-size: 14pt; margin: 0 auto; max-width: 800px; page-break-before: always;"><h1 style="text-align: center;">ANSWER KEYS</h1></div>
                                  <div style="font-family: Times New Roman, serif; font-size: 13pt; margin: 0 auto; max-width: 800px;">`;
                    let answers = ``;
                    questions.forEach((q, index) => {
                        const num = index + 1;
                        if (q.luaChon && q.luaChon.length > 0 && q.loai !== 'multiple-answer') {
                            const correctIndex = (q.luaChon || []).findIndex(opt => opt.correct);
                            if (correctIndex !== -1) answers += `<p style="font-size: 13pt;">${num}. ${String.fromCharCode(65 + correctIndex)}</p>`;
                        }
                    });
                    return keyHtml + answers + '</div>';
                }

                // Logic for 'test' type
                const tracNghiemQuestions = questions.filter(q => q.luaChon && q.luaChon.length > 0);
                const tuLuanQuestions = questions.filter(q => !q.luaChon || q.luaChon.length === 0);

                const totalTracNghiemPoints = tracNghiemQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
                const totalTuLuanPoints = tuLuanQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
                const totalPoints = totalTracNghiemPoints + totalTuLuanPoints;
                const pointPerTracNghiem = tracNghiemQuestions.length > 0 ? (totalTracNghiemPoints / tracNghiemQuestions.length) : 0;
                
                const formatPoints = (p) => parseFloat(p.toFixed(2));

                const keyHeaderHtml = `
                           <table style="width:100%; border: none; font-family: 'Times New Roman', serif; font-size: 13pt; line-height: 1.5;">
                               <tr>
                                   <td style="text-align: center; width: 50%; vertical-align: top;">
                                       <p style="margin:0; text-transform: uppercase;">${headerInfo.donVi}</p>
                                       <table style="margin: 0 auto; border: none; border-collapse: collapse; text-align: center;">
                                           <tr><td style="padding:0 5px; text-transform: uppercase; font-weight: bold;">${headerInfo.tenTruong}</td></tr>
                                       </table>
                                   </td>
                                   <td style="text-align: center; width: 50%; vertical-align: top;">
                                       <p style="margin:0; font-weight: bold; text-transform: uppercase;">HƯỚNG DẪN CHẤM MÔN ${headerInfo.monHoc.toUpperCase()}</p>
                                       <p style="margin:0; font-style: italic;">(Hướng dẫn chấm gồm có 01 trang)</p>
                                   </td>
                               </tr>
                                <tr>
                                   <td style="text-align: center; padding-top: 10px;">
                                       <p style="margin:0; font-weight: bold;">ĐỀ CHÍNH THỨC</p>
                                   </td>
                                   <td></td>
                                </tr>
                           </table>`;

                let keyTableContent = '<table style="width: 100%; border-collapse: collapse; border: 1px solid black; font-family: \'Times New Roman\', serif; font-size: 13pt; margin-top: 15pt;">';
                keyTableContent += `
                    <thead style="font-weight: bold; text-align: center;">
                        <tr>
                            <td style="border: 1px solid black; padding: 5px; width: 25%;">Phần</td>
                            <td style="border: 1px solid black; padding: 5px;">Đáp án</td>
                            <td style="border: 1px solid black; padding: 5px; width: 15%;">Điểm</td>
                        </tr>
                    </thead>
                    <tbody>
                `;

                // Trắc nghiệm Row
                if (tracNghiemQuestions.length > 0) {
                    let answerGrid = '<table style="width: 100%; border-collapse: collapse; text-align: center; border-style: hidden;">';
                    const cols = 7;
                    const numAnswerRows = Math.ceil(tracNghiemQuestions.length / cols);

                    for (let i = 0; i < numAnswerRows; i++) {
                        answerGrid += '<tr>'; // Question number row
                        for (let j = 0; j < cols; j++) {
                            const num = i * cols + j + 1;
                            answerGrid += `<td style="border: 1px solid black; padding: 4px; font-weight: bold;">${num <= tracNghiemQuestions.length ? num : '&nbsp;'}</td>`;
                        }
                        answerGrid += '</tr>';
                        answerGrid += '<tr>'; // Answer letter row
                        for (let j = 0; j < cols; j++) {
                            const numIndex = i * cols + j;
                            if (numIndex < tracNghiemQuestions.length) {
                                const q = tracNghiemQuestions[numIndex];
                                let answerText = '';
                                if (q.luaChon && q.luaChon.length > 0) {
                                    const correctIndex = (q.luaChon || []).findIndex(opt => opt.correct);
                                    answerText = correctIndex !== -1 ? String.fromCharCode(65 + correctIndex) : '';
                                } else {
                                    answerText = q.dapAn || '-';
                                }
                                answerGrid += `<td style="border: 1px solid black; padding: 4px;">${answerText}</td>`;
                            } else {
                                answerGrid += `<td style="border: 1px solid black; padding: 4px;">&nbsp;</td>`;
                            }
                        }
                        answerGrid += '</tr>';
                    }
                    answerGrid += '</table>';
                    
                    keyTableContent += `
                        <tr>
                            <td style="border: 1px solid black; padding: 5px; vertical-align: top; text-align: center;">
                                <strong>Trắc nghiệm: ${formatPoints(totalTracNghiemPoints)} điểm</strong><br>
                                (mỗi câu trả lời đúng được ${formatPoints(pointPerTracNghiem)} đ)
                            </td>
                            <td style="border: 1px solid black; padding: 0;">${answerGrid}</td>
                            <td style="border: 1px solid black; padding: 5px; vertical-align: top; text-align: center; font-weight: bold;">${formatPoints(totalTracNghiemPoints)}đ</td>
                        </tr>
                    `;
                }
                
                // Tự luận Row
                 if (tuLuanQuestions.length > 0) {
                     keyTableContent += `
                         <tr>
                             <td style="border: 1px solid black; padding: 5px; vertical-align: top; text-align: center;">
                                 <strong>Tự luận: ${formatPoints(totalTuLuanPoints)} điểm</strong>
                             </td>
                             <td style="border: 1px solid black; padding: 5px;">
                                 ${tuLuanQuestions.map((q, index) => `
                                     <div style="padding-bottom: 5px;">
                                         <strong>Câu ${tracNghiemQuestions.length + index + 1}:</strong> 
                                         <em>${q.dapAn || 'Học sinh trình bày hợp lí, chính xác...'}</em>
                                     </div>
                                 `).join('')}
                             </td>
                             <td style="border: 1px solid black; padding: 5px; vertical-align: top; text-align: center; font-weight: bold;">
                                 ${tuLuanQuestions.map(q => `<div>${formatPoints(q.points || 0)}đ</div>`).join('')}
                             </td>
                         </tr>
                     `;
                 }

                // Tổng cộng Row
                keyTableContent += `
                    <tr>
                        <td style="border: 1px solid black; padding: 5px; font-weight: bold; text-align: center;">
                            Tổng số câu:<br> ${questions.length} câu <br>(TN + TL)
                        </td>
                        <td style="border: 1px solid black; padding: 5px;"></td>
                        <td style="border: 1px solid black; padding: 5px; font-weight: bold; text-align: center;">${formatPoints(totalPoints)}đ</td>
                    </tr>
                `;


                keyTableContent += '</tbody></table>';

                const footerHtml = `
                    <p style="text-align: center; font-weight: bold; margin-top: 10px;">---Hết---</p>
                    <p style="font-style: italic; margin-top: 10px;">-Học sinh có thể trình bày theo cách khác, hợp lí, chính xác thì cho điểm tối đa.</p>
                `;

                let finalKeyHtml = `<div style="font-family: 'Times New Roman', serif; font-size: 13pt; margin: 0 auto; max-width: 800px;">
                                        ${keyHeaderHtml}
                                        ${keyTableContent}
                                        ${footerHtml}
                                       </div>`;
                
                return finalKeyHtml;
            },

            triggerDownload(htmlContent, filename) {
                const fullHtml = `<!DOCTYPE html><html><head><meta charset='utf-8'></head><body>${htmlContent}</body></html>`;
                const blob = new Blob([fullHtml], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
            }
        };

        TestGeneratorApp.init();
    </script>
</body>

</html>


